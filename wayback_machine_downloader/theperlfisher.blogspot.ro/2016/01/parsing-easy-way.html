<!DOCTYPE html>
<html class='v2' dir='ltr' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
<meta content='width=1100' name='viewport'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='http://theperlfisher.blogspot.ro/favicon.ico' rel='icon' type='image/x-icon'/>
<link href='http://theperlfisher.blogspot.com/2016/01/parsing-easy-way.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="The Perl Fisher - Atom" href="http://theperlfisher.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="The Perl Fisher - RSS" href="http://theperlfisher.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="The Perl Fisher - Atom" href="https://www.blogger.com/feeds/5431247843063773408/posts/default" />

<link rel="alternate" type="application/atom+xml" title="The Perl Fisher - Atom" href="http://theperlfisher.blogspot.com/feeds/7392564289253545672/comments/default" />
<!--[if IE]><script type="text/javascript" src="https://www.blogger.com/static/v1/jsbin/4111605327-ieretrofit.js"></script>
<![endif]-->
<meta content='http://theperlfisher.blogspot.com/2016/01/parsing-easy-way.html' property='og:url'/>
<meta content='Parsing the easy way' property='og:title'/>
<meta content=' Caveat Emptor  There are many Perl 6 tutorials out there, this is not one of them. It assumes some familiarity with the language and some f...' property='og:description'/>
<!--[if IE]> <script> (function() { var html5 = ("abbr,article,aside,audio,canvas,datalist,details," + "figure,footer,header,hgroup,mark,menu,meter,nav,output," + "progress,section,time,video").split(','); for (var i = 0; i < html5.length; i++) { document.createElement(html5[i]); } try { document.execCommand('BackgroundImageCache', false, true); } catch(e) {} })(); </script> <![endif]-->
<title>The Perl Fisher: Parsing the easy way</title>
<link href="https://fonts.googleapis.com/css?kit=KGBfwabt0ZRLA5W1ywjowSwDhbeAHj2kWwu8g6_PFwA" rel="stylesheet" type="text/css"><link type='text/css' rel='stylesheet' href='https://www.blogger.com/static/v1/widgets/1691512649-css_bundle_v2.css' />
<link type='text/css' rel='stylesheet' href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=5431247843063773408&amp;zx=6b3092b8-0175-4f7f-9a70-d7808ba4d4bb' />
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Simple
Designer: Josh Peterson
URL:      www.noaesthetic.com
----------------------------------------------- */

/* Content
----------------------------------------------- */
body {
font: normal normal 12px 'Trebuchet MS', Trebuchet, Verdana, sans-serif;
color: #666666;
background: #ffffff none repeat scroll top left;
padding: 0 0 0 0;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
h2 {
font-size: 22px;
}
a:link {
text-decoration:none;
color: #2288bb;
}
a:visited {
text-decoration:none;
color: #888888;
}
a:hover {
text-decoration:underline;
color: #33aaff;
}
.body-fauxcolumn-outer .fauxcolumn-inner {
background: transparent none repeat scroll top left;
_background-image: none;
}
.body-fauxcolumn-outer .cap-top {
position: absolute;
z-index: 1;
height: 400px;
width: 100%;
}
.body-fauxcolumn-outer .cap-top .cap-left {
width: 100%;
background: transparent none repeat-x scroll top left;
_background-image: none;
}
.content-outer {
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 #333333;
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
margin-bottom: 1px;
}
.content-inner {
padding: 10px 40px;
}
.content-inner {
background-color: #ffffff;
}
/* Header
----------------------------------------------- */
.header-outer {
background: transparent none repeat-x scroll 0 -400px;
_background-image: none;
}
.Header h1 {
font: normal bold 50px Dancing Script;
color: #000000;
text-shadow: 0 0 0 rgba(0, 0, 0, .2);
}
.Header h1 a {
color: #000000;
}
.Header .description {
font-size: 18px;
color: #000000;
}
.header-inner .Header .titlewrapper {
padding: 22px 0;
}
.header-inner .Header .descriptionwrapper {
padding: 0 0;
}
/* Tabs
----------------------------------------------- */
.tabs-inner .section:first-child {
border-top: 0 solid #dddddd;
}
.tabs-inner .section:first-child ul {
margin-top: -1px;
border-top: 1px solid #dddddd;
border-left: 1px solid #dddddd;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget ul {
background: transparent none repeat-x scroll 0 -800px;
_background-image: none;
border-bottom: 1px solid #dddddd;
margin-top: 0;
margin-left: -30px;
margin-right: -30px;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .6em 1em;
font: normal normal 12px 'Trebuchet MS', Trebuchet, Verdana, sans-serif;
color: #000000;
border-left: 1px solid #ffffff;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget li:first-child a {
border-left: none;
}
.tabs-inner .widget li.selected a, .tabs-inner .widget li a:hover {
color: #000000;
background-color: #eeeeee;
text-decoration: none;
}
/* Columns
----------------------------------------------- */
.main-outer {
border-top: 0 solid transparent;
}
.fauxcolumn-left-outer .fauxcolumn-inner {
border-right: 1px solid transparent;
}
.fauxcolumn-right-outer .fauxcolumn-inner {
border-left: 1px solid transparent;
}
/* Headings
----------------------------------------------- */
div.widget > h2,
div.widget h2.title {
margin: 0 0 1em 0;
font: normal bold 12px 'Courier New', Courier, FreeMono, monospace;
color: #000000;
}
/* Widgets
----------------------------------------------- */
.widget .zippy {
color: #999999;
text-shadow: 2px 2px 1px rgba(0, 0, 0, .1);
}
.widget .popular-posts ul {
list-style: none;
}
/* Posts
----------------------------------------------- */
h2.date-header {
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
}
.date-header span {
background-color: #bbbbbb;
color: #ffffff;
padding: 0.4em;
letter-spacing: 3px;
margin: inherit;
}
.main-inner {
padding-top: 35px;
padding-bottom: 65px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-center-inner .section {
margin: 0 1em;
}
.post {
margin: 0 0 45px 0;
}
h3.post-title, .comments h4 {
font: normal normal 22px 'Trebuchet MS',Trebuchet,Verdana,sans-serif;
margin: .75em 0 0;
}
.post-body {
font-size: 110%;
line-height: 1.4;
position: relative;
}
.post-body img, .post-body .tr-caption-container, .Profile img, .Image img,
.BlogList .item-thumbnail img {
padding: 2px;
background: #ffffff;
border: 1px solid #eeeeee;
-moz-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
-webkit-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
}
.post-body img, .post-body .tr-caption-container {
padding: 5px;
}
.post-body .tr-caption-container {
color: #666666;
}
.post-body .tr-caption-container img {
padding: 0;
background: transparent;
border: none;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
box-shadow: 0 0 0 rgba(0, 0, 0, .1);
}
.post-header {
margin: 0 0 1.5em;
line-height: 1.6;
font-size: 90%;
}
.post-footer {
margin: 20px -2px 0;
padding: 5px 10px;
color: #666666;
background-color: #eeeeee;
border-bottom: 1px solid #eeeeee;
line-height: 1.6;
font-size: 90%;
}
#comments .comment-author {
padding-top: 1.5em;
border-top: 1px solid transparent;
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
#comments .avatar-image-container img {
border: 1px solid #eeeeee;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #999999;
border-bottom: 1px solid #999999;
}
.comments .comment-thread.inline-thread {
background-color: #eeeeee;
}
.comments .continue {
border-top: 2px solid #999999;
}
/* Accents
---------------------------------------------- */
.section-columns td.columns-cell {
border-left: 1px solid transparent;
}
.blog-pager {
background: transparent url(//www.blogblog.com/1kt/simple/paging_dot.png) repeat-x scroll top center;
}
.blog-pager-older-link, .home-link,
.blog-pager-newer-link {
background-color: #ffffff;
padding: 5px;
}
.footer-outer {
border-top: 1px dashed #bbbbbb;
}
/* Mobile
----------------------------------------------- */
body.mobile  {
background-size: auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
.mobile .body-fauxcolumn-outer .cap-top {
background-size: 100% auto;
}
.mobile .content-outer {
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
}
.mobile .tabs-inner .widget ul {
margin-left: 0;
margin-right: 0;
}
.mobile .post {
margin: 0;
}
.mobile .main-inner .column-center-inner .section {
margin: 0;
}
.mobile .date-header span {
padding: 0.1em 10px;
margin: 0 -10px;
}
.mobile h3.post-title {
margin: 0;
}
.mobile .blog-pager {
background: transparent none no-repeat scroll top center;
}
.mobile .footer-outer {
border-top: none;
}
.mobile .main-inner, .mobile .footer-inner {
background-color: #ffffff;
}
.mobile-index-contents {
color: #666666;
}
.mobile-link-button {
background-color: #2288bb;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile .tabs-inner .section:first-child {
border-top: none;
}
.mobile .tabs-inner .PageList .widget-content {
background-color: #eeeeee;
color: #000000;
border-top: 1px solid #dddddd;
border-bottom: 1px solid #dddddd;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #dddddd;
}

--></style>
<style id='template-skin-1' type='text/css'><!--
body {
min-width: 960px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 960px;
max-width: 960px;
_width: 960px;
}
.main-inner .columns {
padding-left: 0;
padding-right: 310px;
}
.main-inner .fauxcolumn-center-outer {
left: 0;
right: 310px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0") -
parseInt("310px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0;
}
.main-inner .fauxcolumn-right-outer {
width: 310px;
}
.main-inner .column-left-outer {
width: 0;
right: 100%;
margin-left: -0;
}
.main-inner .column-right-outer {
width: 310px;
margin-right: -310px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
--></style>
<script type="text/javascript">function a(){var b=window.location.href,c=b.split("?");switch(c.length){case 1:return b+"?m=1";case 2:return 0<=c[1].search("(^|&)m=")?null:b+"&m=1";default:return null}}var d=navigator.userAgent;if(-1!=d.indexOf("Mobile")&&-1!=d.indexOf("WebKit")&&-1==d.indexOf("iPad")||-1!=d.indexOf("Opera Mini")||-1!=d.indexOf("IEMobile")){var e=a();e&&window.location.replace(e)};
</script></head>
<body class='loading variant-simplysimple'>
<div class='navbar section' id='navbar' name='Navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d5431247843063773408\x26blogName\x3dThe+Perl+Fisher\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dLIGHT\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttp://theperlfisher.blogspot.com/search\x26blogLocale\x3den\x26v\x3d2\x26homepageUrl\x3dhttp://theperlfisher.blogspot.com/\x26targetPostID\x3d7392564289253545672\x26blogPostOrPageUrl\x3dhttp://theperlfisher.blogspot.com/2016/01/parsing-easy-way.html\x26vt\x3d7269344209967297474',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div class='body-fauxcolumns'>
<div class='fauxcolumn-outer body-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content'>
<div class='content-fauxcolumns'>
<div class='fauxcolumn-outer content-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content-outer'>
<div class='content-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left content-fauxborder-left'>
<div class='fauxborder-right content-fauxborder-right'></div>
<div class='content-inner'>
<header>
<div class='header-outer'>
<div class='header-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left header-fauxborder-left'>
<div class='fauxborder-right header-fauxborder-right'></div>
<div class='region-inner header-inner'>
<div class='header section' id='header' name='Header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
<a href='http://theperlfisher.blogspot.ro/'>The Perl Fisher</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span>
</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class='header-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</header>
<div class='tabs-outer'>
<div class='tabs-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left tabs-fauxborder-left'>
<div class='fauxborder-right tabs-fauxborder-right'></div>
<div class='region-inner tabs-inner'>
<div class='tabs no-items section' id='crosscol' name='Cross-Column'></div>
<div class='tabs no-items section' id='crosscol-overflow' name='Cross-Column 2'></div>
</div>
</div>
<div class='tabs-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='main-outer'>
<div class='main-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left main-fauxborder-left'>
<div class='fauxborder-right main-fauxborder-right'></div>
<div class='region-inner main-inner'>
<div class='columns fauxcolumns'>
<div class='fauxcolumn-outer fauxcolumn-center-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-left-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-right-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class='columns-inner'>
<div class='column-center-outer'>
<div class='column-center-inner'>
<div class='main section' id='main' name='Main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>05 January 2016</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='7392564289253545672' itemprop='postId'/>
<a name='7392564289253545672'></a>
<h3 class='post-title entry-title' itemprop='name'>
Parsing the easy way
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-7392564289253545672' itemprop='description articleBody'>
<h2>
Caveat Emptor </h2>
There are many Perl 6 tutorials out there, this is not one of them. It assumes some familiarity with the language and some familiarity with regular expressions, the mini-language that Perl 6 grammars derived from. You should probably also have an idea of why someone would want to write one.<br />
<br />
I'm going to simply talk about being able to take a file in a given language (PHP is my chosen victim, as being able to interpret PHP code in Perl 6 seems like a useful goal) and create a grammar (giant regular expression) that turns your PHP code into a Perl 6 match object which you can then walk.<br />
<br />
If this doesn't sound useful to you, well, it isn't without a bit of additional work. In Perl 6 you can combine this matching object with a set of actions that trigger when a match is made, and <i>those</i> can do many wondrous things. For instance, an action could be made that triggers when '$a = 5;' is matched, and that could set the Perl 6 variable $a to 5, thus setting a Perl 6 variable from inside PHP 5 code.<br />
<h2>
Inspiration </h2>
I'm working on some talks for upcoming conferences&nbsp; (FOSDEM, OSCON to name a few), and was stuck on how to explain a clean way to write and debug a parser. I'd rather not go the CS 401 generic route of creating the usual expression grammar thing that everyone uses to prove what a pain left-recursion can be, so I figured that PHP would be worthwhile, and if I can get a full PHP grammar out of a talk, so be it.<br />
<br />
Now, PHP being a Perl derivative means that the grammar is a bit ... dodgy. If you've ever seen the Perl lexer, you know the challenges we face. There's also the additional challenge of Perl 6 being relatively new, so it's even more important that we work in a stepwise fashion.<br />
<br />
When I created <a href="https://github.com/drforr/perl6-ANTLR4" target="_blank">perl6-ANTLR4</a> I had the benefit of a grammar to work from, and a reasonable idea of how I was going to convert it. With PHP I really had no such guarantee, so through trial-and-error I came across the following approach. It might not scale to the full language, but it's one way of approaching the problem.<br />
<br />
I'll put the full PHP source up on GitHub once I'm convinced this is a workable approach, but the basic idea I've come up with is as follows:<br />
<ol>
<li>Collect the sample source into a corpus/ directory.</li>
<li>Write a test file that parses each file in the corpus.</li>
<li>Write a stub grammar whose TOP rule consists of each file in the corpus separated by an '|' alternation symbol.</li>
<li>Run the test file over the corpus.</li>
<li>For each token you find, create a 'token FOO { ... }' rule. Most of these should be formulaic, and if you're creative with an edge-case test case the rest should fall out.</li>
<li>Search/replace each occurrence of the token with '&lt;FOO&gt;' (and the appropriate quotes, this does get tedious.)</li>
<li>Repeat steps 5 and 6 until the grammar is tokenized.</li>
<li>For each common sequence of tokens you find, create a 'rule bar { ... }' rule that matches them.</li>
<li>Replace the common sequence of tokens with '&lt;bar&gt;' as need be.</li>
<li>Repeat steps 8 and 9 until the language is parsed, or you're out of patience. </li>
</ol>
This won't make much sense without some examples, so I'll draw on my current tackling of PHP for inspiration. Incidentally I'm impressed that the existing Perl 6 grammar construct can handle this approach, which I've already applied to sequences of upwards of several thousand tokens in a row.<br />
<br />
Here's a sample (suitably truncated) Perl 6 test file:<br />
<br />
<blockquote class="tr_bq">
use v6;<br />
use PHP::Grammar;<br />
use Test;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />
<br />
plan 1;<br />
<br />
my $g = PHP::Grammar.new; <br />
<br />
ok $g.parsefile('corpus-5/addglob.php');<br />
ok $g.parsefile('corpus-5/addpattern.php';
</blockquote>
In a nutshell, this simply tests that our PHP grammar matches the content of addglob.php and addpattern.php in our corpus-5/ directory. It should do so trivially, because the grammar file consists of almost nothing but these two files verbatim.<br />
<br />
The starting grammar file should look like this:<br />
<blockquote class="tr_bq">
use v6;<br />
grammar PHP::Grammar<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
# corpus-5/addglob.php below, just stick it in quotes. &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />
'&lt;?php </blockquote>
<blockquote class="tr_bq">
class a {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public function test($arg = c::TESTCONSTANT) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo __METHOD__ . "($arg)\n";<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static public function staticTest() {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
}'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />
<br />
|<br />
# corpus-5/addpattern.php below, remember to escape "'&lt;'.'?php';?&gt;"<br />
'#!/usr/bin/php<br />
&lt;?php<br />
echo \'&lt;\'.\'?php\';?&gt;<br />
<br />
foreach(array("SPL", "Reflection", "Phar") as $ext) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!extension_loaded($ext)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "$argv[0] requires PHP extension $ext.\n";<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(1);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />
} ?&gt;'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp; </blockquote>
This is, of course, a <b>horrible</b> abuse of the Perl 6 grammar system, but it's a testament to the fact that the system works, and you can incrementally develop your grammar from this baseline. This "parser" just checks its input string to see if it matches the content of addglob.php or addpattern.php, and if so, returns True. You can also ask it for the match contents, and lo and behold, it will return one or the other of the match strings.<br />
<br />
Of course, this is only useful if you want your grammar to match the contents of these two files. We're aspiring to something a little greater than this, so bear with me. Incidentally, if you're copy/pasting the source code from this posting, please make sure the "} ?&gt;'" is flush-left in your editor.<br />
<br />
Enclosing the entire string in quotes means that the match is open to the vagaries of whitespace, so if you're going to follow me on this journey I'd recommend copying and pasting the files yourself rather than relying on the browser to keep whitespace intact. <br />
<h2>
Bottoms Up!</h2>
We're going to start by giving each term (like '3', 'foreach' or '"Hello world!"') in our program a name. This is backwards from the usual process, because ordinarily we'd have a grammar description in another language to guide us. The problem is that, well, most grammars like yacc, bison and ANTLR simply aren't Perl, and don't quite map onto the tools we have at our disposal.<br />
<br />
Basically, you can think of this process as refactoring a regular expression, but an RE that's far more powerful than what you've had at your disposal with Perl 5 or its brethren and sistren.<br />
<br />
Let's start this process by looking at '!extension_loaded($ext)' in the source. We'll say that everything that corresponds to a <b>single</b> string in the source gets labeled in all UPPER CASE. Later on this will keep us from confusing things.<br />
<br />
So, in this context, `!` is the negation operator, so we'll name it NEGATION-OP. `extension_loaded` is a function name, so we'll call it FUNCTION-NAME. Likewise `$ext` is a scalar variable, so we'll just call it SCALAR.<br />
<br />
In the grammar, we can replace `!` with `&lt;NEGATION-OP&gt;`, `extension_loaded` with `&lt;FUNCTION-NAME&gt;` and `$ext` gets replaced with `&lt;SCALAR&gt;`. You'll notice that `(` and `)` didn't get names. They're really more placeholders than anything, so we'll keep `(`, `)', `{`, `}` and so on just as raw text. <br />
<h2>
Break it Down</h2>
For the moment, though, we'll just give the simple things in the program names, like `static`, `function` and `class`. You can already start to see how things might group though, just looking at this new version: <br />
<blockquote class="tr_bq">
use v6;<br />grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token STATIC { 'static' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token CLASS { 'class' } <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token PUBLIC { 'public' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token FUNCTION { 'function' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token FOREACH { 'foreach' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token AS { 'as' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token IF { 'if' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token ECHO { 'echo' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token EXIT { 'exit' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />'&lt;?php'<br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;PUBLIC&gt; &lt;FUNCTION&gt; 'test($arg = c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ . "($arg)\n";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;STATIC&gt; &lt;PUBLIC&gt; &lt;FUNCTION&gt; 'staticTest() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;ECHO&gt; '\'&lt;\'.\'?php\';?&gt;'<br /><br />&lt;FOREACH&gt; '(array("SPL", "Reflection", "Phar")' &lt;AS&gt; '$ext) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!extension_loaded($ext)) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '"$argv[0] requires PHP extension $ext.\n";'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />} ?&gt;'&nbsp;&nbsp; <br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /></blockquote>
The `token ECHO {...}` is how you assign the string 'echo' its own name, and instead of the raw text 'echo' in the program, you replace it with `&lt;ECHO&gt;`. Don't forget to replace the quotes, because you're effectively interpolating `&lt;ECHO&gt;` into the string.<br />
<br />
We've only replaced the static text here, so it's it's still only going to be able to match the original file contents, but that will change soon enough. You can start to see a bit of how we might be able to refactor some of this at a later date.<br />
<br />
Keeping in mind that Perl 6 grammars are essentially your old regular expressions on steroids, look at `&lt;STATIC&gt; &lt;PUBLIC&gt; &lt;FUNCTION&gt;`. PHP doesn't require that all functions be statically declared, so we could change that to `&lt;STATIC&gt;?` to make both 'static public function foo(...)' and 'public function foo(...)' legal.<br />
<br />
Careful about how far you take this though. If you make both 'static' and 'public' optional like so, `&lt;STATIC&gt;? &lt;PUBLIC&gt;? &lt;FUNCTION&gt;`, this makes 'static function foo(...)' a legal expression. Luckily it is legal in PHP, but other languages might not allow that.<br />
<br />
<h2>
Functionality</h2>
The goal is to give every term here a label, so let's pick on something else. `test(...)` and `selfTest()` seem like the next obvious candidates. Now, our ultimate goal is not to just match these two files, but any PHP program text, and my years of programming experience has led me to deduce that people are going to want to name functions something other than `test` and `selfTest`, so we need to accommodate those people.<br />
<br />
We need a way to match a whole range of identifier characters, and lucky for us, this looks just like it did in Perl 5, using the `\w` character class. <br />
<br />
&nbsp;grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token FUNCTION-NAME { \w+ }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />'&lt;?php'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&lt;CLASS&gt; 'a {'&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; '($arg = c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ . "($arg)\n";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;STATIC&gt; &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; '() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;ECHO&gt; '\'&lt;\'.\'?php\';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '("SPL", "Reflection", "Phar")' &lt;AS&gt; '$ext) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '($ext)) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '"$argv[0] requires PHP extension $ext.\n";'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
<h2>
A brief aside</h2>
You might be thinking "Whoa there, if we're just going to match any old string of letters, haven't we lost something here? Where does this go?" Well, it's really a named capture in a slightly different guise. Back in Perl 5 you were used to doing:<br />
<br />
<blockquote class="tr_bq">
"2+3" =~ /(\d+) \+ (\d+)/x</blockquote>
&nbsp;in order to capture the values `2` and `3` in $1 and $2 respectively, and may even have used the named capture feature. In Perl 6, these get renumbered to $0 and $1 respectively, and even better, you get a hash that you can play with, so a statement like:<br />
<br />
<blockquote class="tr_bq">
"doStuff()" ~~ /&lt;FUNCTION-NAME&gt; '(' ')'/</blockquote>
&nbsp;will capture 'doStuff' in $/{'FUNCTION-NAME'}. Not only do you have a hash to play with, but later on we'll exploit the fact that this $/ object is actually a multi-tiered data structure, so you can put named captures <b>inside</b> named captures to create a hash of hashes for you, and this all happens automatically.<br />
<br />
<h2>
Syntax and Semantics</h2>
There's one other thing that got swept 
under the rug here. Since `test` and `staticTest` both got abstracted 
away under `&lt;FUNCTION-NAME&gt;`, it's entirely possible that once the
 parser is fully complete, `function dup(){} function dup(){}` will<b> </b>actually match, even though it might not be legal PHP code.<br />
<br />
What we're building doesn't distinguish between <i>legal</i> code and <i>syntactically correct</i> code. Generally speaking, if the compiler immediately returns a syntax error, then your parser should be able to catch it. Otherwise don't worry about it.<br />
<br />
For testing purposes it is a good idea to add some corner cases like these, but in general the parser should be very laid-back about what it accepts. `my $x; my $x;` may throw a "redefined value" warning, but the parser should just see two variable declarations in a row, put them into a syntax tree, and go on about its business.<br />
<br />
<h2>
And back to our story.</h2>
Now, let's factor out the strings. For our purposes, strings are nothing but a `"`, some stuff that's <b>not</b> a `"`, then a final `"` to cap it all off. In Perl 6 regex terms, that looks like this (with single-quoted strings thrown in as well):<br />
<br />
<blockquote class="tr_bq">
grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token DQ-STRING { '"' &lt;-[ " ]&gt; '"' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token SQ-STRING { '\'' &lt;-[ ' ]&gt; '\'' }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /><br />'&lt;?php' <br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; '($arg = c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; ';<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;STATIC&gt; &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; '() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'<br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;ECHO&gt; &lt;SQ-STRING&gt; ';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; '$ext) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '($ext)) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; &lt;DQ-STRING&gt; ';'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</blockquote>
Let's now do the big one, scalars. They're just like function names, but with a leading `$`.<br />
<br />
<blockquote class="tr_bq">
grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token SCALAR { '$' \w+ }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />'&lt;?php'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; '= c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; '; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;STATIC&gt; &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; '() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;ECHO&gt; &lt;SQ-STRING&gt; ';&gt;?'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; &lt;SCALAR&gt; ') {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; ')) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; &lt;DQ-STRING&gt; ';'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'</blockquote>
<br />
I'd like to point out that if you've been following along in your own Perl 6 terminal window, that the test cases we've been running haven't failed, or had to be rewritten, yet we've been refactoring the grammar like mad. We may be able to continue this way until the end, running more test files through our corpus of parsing until it handles PHP in all its glory. We may not. At each stage, though, the diffs between files make it clear what we've factored out, and what might have gone wrong.<br />
<br />
<h2>
New Rules</h2>
Now that a lot of the underlying confusion has been stripped away, let's think a little bigger. A lot of dealing with grammars is repeating the mantra "Don't repeat yourself." See how `&lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt;` repeats? Let's refactor that out by creating a new rule. We'll also create another convention that when we clump UPPER-CASE names together, we'll give the clump a lower-case name.<br />
<br />
Since it's almost a function declaration, let's call it that, like so:<br />
<br />
<blockquote class="tr_bq">
grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule function-declaration { &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />'&lt;?php'<br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '(' &lt;SCALAR&gt; '= c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; ';<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;STATIC&gt; &lt;function-declaration&gt; '() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'<br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;ECHO&gt; &lt;SQ-STRING&gt; ';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; &lt;SCALAR&gt; ') {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; ')) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; &lt;DQ-STRING&gt; ';'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</blockquote>
And that's how you create your own rules. Nothing to it, really. You'll notice that we've sort of left `&lt;STATIC&gt;` behind, though. When you're just starting out, it's best to keep your new rules simple, which means they should be just common sequences of terms.<br />
<br />
But again, you can remember too that these rules are just regular expressions in disguise, so you can use your old friend `?` to declare something optional:<br />
<br />
<blockquote class="tr_bq">
grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule function-declaration { &lt;STATIC&gt;? &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /><br />'&lt;?php'<br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '(' &lt;SCALAR&gt; '= c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; ';<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'<br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;ECHO&gt; &lt;SQ-STRING&gt; ';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; &lt;SCALAR&gt; ') {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; ')) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; &lt;DQ-STRING&gt; ';'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /></blockquote>
Just like in regular expressions, `?` makes a name optional. You could make `&lt;PUBLIC&gt;` optional as well, since having a `function foo()` with no `static` or `public` declaration is probably legal, but it might be better to verify that with another corpus file.<br />
<br />
<h2>
Expressionless</h2>
<br />
Now we're going to focus our attention on the `&lt;ECHO&gt; &lt;DQ-STRING&gt;` and `&lt;ECHO&gt; &lt;SQ-STRING&gt;` elements. Since most of the syntax we're using has much in common with regular expressions, you might guess that we can say "either &lt;DQ-STRING&gt; or &lt;SQ-STRING&gt;" with `( &lt;DQ-STRING&gt; | &lt;SQ-STRING&gt; )`, and you'd be right:<br />
<br />
<blockquote class="tr_bq">
grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule echo-expression { &lt;ECHO&gt; ( &lt;SQ-STRING&gt; | &lt;DQ-STRING&gt; ) }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /><br />'&lt;?php'<br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '(' &lt;SCALAR&gt; '= c::TESTCONSTANT) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; ';<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'<br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;echo-expression&gt; ';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; &lt;SCALAR&gt; ') {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; ')) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;echo-expression&gt; ';'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /></blockquote>
There can be a little trap hiding here, though. This alternation works because the two string types differ in their first character, so the parser doesn't have to look ahead to choose which term to follow. If they differ further down, especially if there are `+` or `*` involved, there could be issues.<br />
<br />
Generally you can get rid of these issues by reordering the alternatives, but sometimes it can be something of a waterbed problem. Let's slightly refactor the text after the `&lt;function-declaration&gt;` so we can see another DRY hiding:<br />
<br />
<blockquote class="tr_bq">
&nbsp;grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule echo-expression { &lt;ECHO&gt; ( &lt;SQ-STRING&gt; | &lt;DQ-STRING&gt; ) }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /><br />'&lt;?php'<br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '(' &lt;SCALAR&gt; '= c::TESTCONSTANT' ')' {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; ';<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '(' ')' {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}'<br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;echo-expression&gt; ';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; &lt;SCALAR&gt; ') {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; ')) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;echo-expression&gt; ';'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</blockquote>
<h2>
Getting argumentative</h2>
Separating the `(` `)` makes it a little clearer that we have `&lt;function-declaration&gt; '(' {stuff} ')'` and `&lt;function-declaration&gt; '(' ')'`, which kind of makes {stuff} an option, doesn't it?<br />
<br />
<blockquote class="tr_bq">
grammar PHP::Grammar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule function-declaration<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;STATIC&gt;? &lt;PUBLIC&gt; &lt;FUNCTION&gt; &lt;FUNCTION-NAME&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '('<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ( &lt;SCALAR&gt; '= c::TESTCONSTANT' )?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ')'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rule TOP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />'&lt;?php'<br />&lt;CLASS&gt; 'a {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '{'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ECHO&gt; '__METHOD__ .' &lt;DQ-STRING&gt; ';<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;function-declaration&gt; '{'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '}<br />}'<br /><br />|<br /><br />'#!/usr/bin/php<br />&lt;?php'<br />&lt;echo-expression&gt; ';?&gt;'<br /><br />&lt;FOREACH&gt; '(' &lt;FUNCTION-NAME&gt; '(' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ',' &lt;DQ-STRING&gt; ')' &lt;AS&gt; &lt;SCALAR&gt; ') {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;IF&gt; '(!' &lt;FUNCTION-NAME&gt; '(' &lt;SCALAR&gt; ')) {'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;echo-expression&gt; ';' <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;EXIT&gt; '(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />} ?&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</blockquote>
So, by treating the `&lt;SCALAR&gt; '=...'` as an option, we've factored even more code out, and I hope that by now you can see where to take this. Basically, from here the idea is to take a file, add it to your test suite, boil it down as far as you can, then repeat with a new test file. After two or three iterations of this process, you don't really even need to add the new test file, you'll just be able to add a new test case (please, please don't forget the test case and corner cases) and plug in the new bit of grammar.<br />
<br />
And of course most of this really isn't necessary if you have a grammar to work from, but I've found that even when you do have a grammar to work from, sometimes it helps to tear it down and rebuild it from scratch. <br />
<h2>
Denoument</h2>
I'll be the first to admit that going through an entire corpus of PHP files this way is impractical. But I've also tried going at this problem from the other end, namely taking a large grammar and beating on it until it managed to process the files I wanted it to read. (At least until the GLR, that is, but that's a separate issue.)<br />
<br />
Now, even for a fairly large language, you don't have to take each file and tokenize them by hand, it soon becomes apparent what are tokens and what aren't, and Perl 6 has convenient whitespace rules to help the boundaries fall where they may.<br />
<br />
I think the issue is the grammar debugger/tracer isn't <i>quite</i> tooled up to where I'd like it to be, and I'm going to take a crack at it after or maybe during FOSDEM.<br />
<br />
The last time I checked, the tracer spit out the entire AST in raw .perl format, albeit with some indentation. What I really need to get out of that is simply the text with an &lt;eject&gt; character where the parser bailed, and a traceback of what rules it was running at the time it failed. That would help me more than the raw .perl format, and again I can probably do it, and want to take some time to straighten out the issue. I think the tools give me enough access to do what I want, and at that point I'd love to be able to throw a live debugger into a tmux session, and be able to tweak/rerun the debugging, say "Oh, it was in the expression-core rule at 'a := foo' and that binding expression hasn't been written yet."<br />
<br />
In my copious free time, I guess. In any case, I hope I've laid bare some of the mysteries awaiting you in the depths of the Perl 6 grammars.<br />
<br />
Thanks and until next time,<br />
<br />
Happy coding!
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2016/01/parsing-easy-way.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2016/01/parsing-easy-way.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2016-01-05T03:47:00+02:00'>03:47</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=7392564289253545672&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7392564289253545672&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7392564289253545672&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7392564289253545672&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7392564289253545672&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7392564289253545672&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2016/01/parsing-easy-way.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
<div class='comments' id='comments'>
<a name='comments'></a>
<h4>No comments:</h4>
<div id='Blog1_comments-block-wrapper'>
<dl class='avatar-comment-indent' id='comments-block'>
</dl>
</div>
<p class='comment-footer'>
<div class='comment-form'>
<a name='comment-form'></a>
<h4 id='comment-post-message'>Post a Comment</h4>
<p>
</p>
<a href='https://www.blogger.com/comment-iframe.g?blogID=5431247843063773408&postID=7392564289253545672' id='comment-editor-src'></a>
<iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410px' id='comment-editor' name='comment-editor' src='' width='100%'></iframe>
<script type="text/javascript" src="https://www.blogger.com/static/v1/jsbin/1003877814-comment_from_post_iframe.js"></script>
<script type='text/javascript'>
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
</p>
<div id='backlinks-container'>
<div id='Blog1_backlinks-container'>
</div>
</div>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-newer-link'>
<a class='blog-pager-newer-link' href='http://theperlfisher.blogspot.ro/2016/01/bottoms-up.html' id='Blog1_blog-pager-newer-link' title='Newer Post'>Newer Post</a>
</span>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='http://theperlfisher.blogspot.ro/2015/07/rough-and-tumble-on-irc.html' id='Blog1_blog-pager-older-link' title='Older Post'>Older Post</a>
</span>
<a class='home-link' href='http://theperlfisher.blogspot.ro/'>Home</a>
</div>
<div class='clear'></div>
<div class='post-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='http://theperlfisher.blogspot.com/feeds/7392564289253545672/comments/default' target='_blank' type='application/atom+xml'>Post Comments (Atom)</a>
</div>
</div>
<script type="text/javascript">window.___gcfg = {'lang': 'en'};</script>
</div></div>
</div>
</div>
<div class='column-left-outer'>
<div class='column-left-inner'>
<aside>
</aside>
</div>
</div>
<div class='column-right-outer'>
<div class='column-right-inner'>
<aside>
<div class='sidebar section' id='sidebar-right-1'><div class='widget Profile' data-version='1' id='Profile1'>
<h2>About Me</h2>
<div class='widget-content'>
<dl class='profile-datablock'>
<dt class='profile-data'>
<a class='profile-name-link g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' style='background-image: url(//www.blogger.com/img/logo-16.png);'>
DrForr
</a>
</dt>
</dl>
<a class='profile-link' href='https://www.blogger.com/profile/18252182597447689159' rel='author'>View my complete profile</a>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5431247843063773408&widgetType=Profile&widgetId=Profile1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("Profile1"));' target='configProfile1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Blog Archive</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/search?updated-min=2016-01-01T00:00:00%2B02:00&amp;updated-max=2017-01-01T00:00:00%2B02:00&amp;max-results=6'>
2016
</a>
<span class='post-count' dir='ltr'>(6)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2016_02_01_archive.html'>
February
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2016_01_01_archive.html'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='posts'>
<li><a href='http://theperlfisher.blogspot.ro/2016/01/bottoms-up.html'>Bottoms Up</a></li>
<li><a href='http://theperlfisher.blogspot.ro/2016/01/parsing-easy-way.html'>Parsing the easy way</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/search?updated-min=2015-01-01T00:00:00%2B02:00&amp;updated-max=2016-01-01T00:00:00%2B02:00&amp;max-results=2'>
2015
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2015_07_01_archive.html'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2015_05_01_archive.html'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5431247843063773408&widgetType=BlogArchive&widgetId=BlogArchive1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("BlogArchive1"));' target='configBlogArchive1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div></div>
</aside>
</div>
</div>
</div>
<div style='clear: both'></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class='main-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<footer>
<div class='footer-outer'>
<div class='footer-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left footer-fauxborder-left'>
<div class='fauxborder-right footer-fauxborder-right'></div>
<div class='region-inner footer-inner'>
<div class='foot no-items section' id='footer-1'></div>
<!-- outside of the include in order to lock Attribution widget -->
<div class='foot section' id='footer-3' name='Footer'><div class='widget Attribution' data-version='1' id='Attribution1'>
<div class='widget-content' style='text-align: center;'>
Simple template. Powered by <a href='https://www.blogger.com' target='_blank'>Blogger</a>.
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5431247843063773408&widgetType=Attribution&widgetId=Attribution1&action=editWidget&sectionId=footer-3' onclick='return _WidgetManager._PopupConfig(document.getElementById("Attribution1"));' target='configAttribution1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div></div>
</div>
</div>
<div class='footer-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class='content-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<script type='text/javascript'>
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>


<!-- 'It is your responsibility to notify your visitors about cookies used on your blog. See http://www.blogger.com/go/cookiechoices for more details.' -->
<script src="/js/cookiechoices.js" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function(event) {
    window.cookieChoices && cookieChoices.showCookieConsentBar && cookieChoices.showCookieConsentBar(
        (window.cookieOptions && cookieOptions.msg) || 'This site uses cookies from Google to deliver its services, to personalize ads and to analyze traffic. Information about your use of this site is shared with Google. By using this site, you agree to its use of cookies.',
        (window.cookieOptions && cookieOptions.close) || 'Got it',
        (window.cookieOptions && cookieOptions.learn) || 'Learn More',
        (window.cookieOptions && cookieOptions.link) || 'https://www.blogger.com/go/blogspot-cookies');
  });
</script>


<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/1016236460-widgets.js"></script>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY5X_X7unOKlMf2Y_ScxXBIffj67xA:1487980636545';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d5431247843063773408','//theperlfisher.blogspot.ro/2016/01/parsing-easy-way.html','5431247843063773408');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '5431247843063773408', 'bloggerUrl': 'https://www.blogger.com', 'title': 'The Perl Fisher', 'pageType': 'item', 'postId': '7392564289253545672', 'url': 'http://theperlfisher.blogspot.ro/2016/01/parsing-easy-way.html', 'canonicalUrl': 'http://theperlfisher.blogspot.com/2016/01/parsing-easy-way.html', 'homepageUrl': 'http://theperlfisher.blogspot.ro/', 'searchUrl': 'http://theperlfisher.blogspot.ro/search', 'canonicalHomepageUrl': 'http://theperlfisher.blogspot.com/', 'blogspotFaviconUrl': 'http://theperlfisher.blogspot.ro/favicon.ico', 'hasCustomDomain': false, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'useUniversalAnalytics': false, 'pageName': 'Parsing the easy way', 'pageTitle': 'The Perl Fisher: Parsing the easy way', 'encoding': 'UTF-8', 'locale': 'en', 'localeUnderscoreDelimited': 'en', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'languageDirection': 'ltr', 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22The Perl Fisher - Atom\x22 href\x3d\x22http://theperlfisher.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22The Perl Fisher - RSS\x22 href\x3d\x22http://theperlfisher.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22The Perl Fisher - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/5431247843063773408/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22The Perl Fisher - Atom\x22 href\x3d\x22http://theperlfisher.blogspot.com/feeds/7392564289253545672/comments/default\x22 /\x3e\n', 'meTag': '', 'openIdOpTag': '', 'mobileHeadScript': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'ieCssRetrofitLinks': '\x3c!--[if IE]\x3e\x3cscript type\x3d\x22text/javascript\x22 src\x3d\x22https://www.blogger.com/static/v1/jsbin/4111605327-ieretrofit.js\x22\x3e\x3c/script\x3e\n\x3c![endif]--\x3e', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/4e551dbee4655456', 'plusOneApiSrc': 'https://apis.google.com/js/plusone.js', 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Google+', 'key': 'googlePlus', 'shareMessage': 'Share to Google+', 'target': 'googleplus'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'googlePlusShareButtonWidth': 300, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}}}, {'name': 'features', 'data': {'enhancedSourcesets': 'true', 'unsupported_browser_message': 'false'}}, {'name': 'messages', 'data': {'linkCopiedToClipboard': 'Link copied to clipboard!', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'name': 'custom', 'localizedName': 'Custom', 'variant': 'simplysimple', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': true}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'Parsing the easy way', 'description': ' Caveat Emptor  There are many Perl 6 tutorials out there, this is not one of them. It assumes some familiarity with the language and some f...', 'url': 'http://theperlfisher.blogspot.ro/2016/01/parsing-easy-way.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 7392564289253545672}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', null, document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', null, document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', null, document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1130279207-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/368954415-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_ProfileView', new _WidgetInfo('Profile1', 'sidebar-right-1', null, document.getElementById('Profile1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', null, document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', null, document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>
</body>
</html>