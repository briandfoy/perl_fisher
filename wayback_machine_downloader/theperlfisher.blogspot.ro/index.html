<!DOCTYPE html>
<html class='v2' dir='ltr' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/2437439463-css_bundle_v2.css' rel='stylesheet' type='text/css'/>
<meta content='width=1100' name='viewport'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='http://theperlfisher.blogspot.ro/favicon.ico' rel='icon' type='image/x-icon'/>
<link href='http://theperlfisher.blogspot.com/' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="The Perl Fisher - Atom" href="http://theperlfisher.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="The Perl Fisher - RSS" href="http://theperlfisher.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="The Perl Fisher - Atom" href="https://www.blogger.com/feeds/5431247843063773408/posts/default" />
<link rel="me" href="https://www.blogger.com/profile/18252182597447689159" />
<link rel="openid.server" href="https://www.blogger.com/openid-server.g" />
<link rel="openid.delegate" href="http://theperlfisher.blogspot.com/" />
<!--[if IE]><script type="text/javascript" src="https://www.blogger.com/static/v1/jsbin/3658603751-ieretrofit.js"></script>
<![endif]-->
<meta content='http://theperlfisher.blogspot.com/' property='og:url'/>
<meta content='The Perl Fisher' property='og:title'/>
<meta content='' property='og:description'/>
<!--[if IE]> <script> (function() { var html5 = ("abbr,article,aside,audio,canvas,datalist,details," + "figure,footer,header,hgroup,mark,menu,meter,nav,output," + "progress,section,time,video").split(','); for (var i = 0; i < html5.length; i++) { document.createElement(html5[i]); } try { document.execCommand('BackgroundImageCache', false, true); } catch(e) {} })(); </script> <![endif]-->
<title>The Perl Fisher</title>
<style type='text/css'>@font-face{font-family:'Dancing Script';font-style:normal;font-weight:700;src:local('Dancing Script Bold'),local('DancingScript-Bold'),url(//fonts.gstatic.com/s/dancingscript/v9/If2SXTr6YS-zF4S-kcSWSVi_szpbr_QqqiY.ttf)format('truetype');}</style>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Simple
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */

/* Content
----------------------------------------------- */
body {
font: normal normal 12px 'Trebuchet MS', Trebuchet, Verdana, sans-serif;
color: #666666;
background: #ffffff none repeat scroll top left;
padding: 0 0 0 0;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
h2 {
font-size: 22px;
}
a:link {
text-decoration:none;
color: #2288bb;
}
a:visited {
text-decoration:none;
color: #888888;
}
a:hover {
text-decoration:underline;
color: #33aaff;
}
.body-fauxcolumn-outer .fauxcolumn-inner {
background: transparent none repeat scroll top left;
_background-image: none;
}
.body-fauxcolumn-outer .cap-top {
position: absolute;
z-index: 1;
height: 400px;
width: 100%;
}
.body-fauxcolumn-outer .cap-top .cap-left {
width: 100%;
background: transparent none repeat-x scroll top left;
_background-image: none;
}
.content-outer {
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 #333333;
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
margin-bottom: 1px;
}
.content-inner {
padding: 10px 40px;
}
.content-inner {
background-color: #ffffff;
}
/* Header
----------------------------------------------- */
.header-outer {
background: transparent none repeat-x scroll 0 -400px;
_background-image: none;
}
.Header h1 {
font: normal bold 50px Dancing Script;
color: #000000;
text-shadow: 0 0 0 rgba(0, 0, 0, .2);
}
.Header h1 a {
color: #000000;
}
.Header .description {
font-size: 18px;
color: #000000;
}
.header-inner .Header .titlewrapper {
padding: 22px 0;
}
.header-inner .Header .descriptionwrapper {
padding: 0 0;
}
/* Tabs
----------------------------------------------- */
.tabs-inner .section:first-child {
border-top: 0 solid #dddddd;
}
.tabs-inner .section:first-child ul {
margin-top: -1px;
border-top: 1px solid #dddddd;
border-left: 1px solid #dddddd;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget ul {
background: transparent none repeat-x scroll 0 -800px;
_background-image: none;
border-bottom: 1px solid #dddddd;
margin-top: 0;
margin-left: -30px;
margin-right: -30px;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .6em 1em;
font: normal normal 12px 'Trebuchet MS', Trebuchet, Verdana, sans-serif;
color: #000000;
border-left: 1px solid #ffffff;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget li:first-child a {
border-left: none;
}
.tabs-inner .widget li.selected a, .tabs-inner .widget li a:hover {
color: #000000;
background-color: #eeeeee;
text-decoration: none;
}
/* Columns
----------------------------------------------- */
.main-outer {
border-top: 0 solid transparent;
}
.fauxcolumn-left-outer .fauxcolumn-inner {
border-right: 1px solid transparent;
}
.fauxcolumn-right-outer .fauxcolumn-inner {
border-left: 1px solid transparent;
}
/* Headings
----------------------------------------------- */
div.widget > h2,
div.widget h2.title {
margin: 0 0 1em 0;
font: normal bold 12px 'Courier New', Courier, FreeMono, monospace;
color: #000000;
}
/* Widgets
----------------------------------------------- */
.widget .zippy {
color: #999999;
text-shadow: 2px 2px 1px rgba(0, 0, 0, .1);
}
.widget .popular-posts ul {
list-style: none;
}
/* Posts
----------------------------------------------- */
h2.date-header {
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
}
.date-header span {
background-color: #bbbbbb;
color: #ffffff;
padding: 0.4em;
letter-spacing: 3px;
margin: inherit;
}
.main-inner {
padding-top: 35px;
padding-bottom: 65px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-center-inner .section {
margin: 0 1em;
}
.post {
margin: 0 0 45px 0;
}
h3.post-title, .comments h4 {
font: normal normal 22px 'Trebuchet MS',Trebuchet,Verdana,sans-serif;
margin: .75em 0 0;
}
.post-body {
font-size: 110%;
line-height: 1.4;
position: relative;
}
.post-body img, .post-body .tr-caption-container, .Profile img, .Image img,
.BlogList .item-thumbnail img {
padding: 2px;
background: #ffffff;
border: 1px solid #eeeeee;
-moz-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
-webkit-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
}
.post-body img, .post-body .tr-caption-container {
padding: 5px;
}
.post-body .tr-caption-container {
color: #666666;
}
.post-body .tr-caption-container img {
padding: 0;
background: transparent;
border: none;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
box-shadow: 0 0 0 rgba(0, 0, 0, .1);
}
.post-header {
margin: 0 0 1.5em;
line-height: 1.6;
font-size: 90%;
}
.post-footer {
margin: 20px -2px 0;
padding: 5px 10px;
color: #666666;
background-color: #eeeeee;
border-bottom: 1px solid #eeeeee;
line-height: 1.6;
font-size: 90%;
}
#comments .comment-author {
padding-top: 1.5em;
border-top: 1px solid transparent;
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
#comments .avatar-image-container img {
border: 1px solid #eeeeee;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #999999;
border-bottom: 1px solid #999999;
}
.comments .comment-thread.inline-thread {
background-color: #eeeeee;
}
.comments .continue {
border-top: 2px solid #999999;
}
/* Accents
---------------------------------------------- */
.section-columns td.columns-cell {
border-left: 1px solid transparent;
}
.blog-pager {
background: transparent url(//www.blogblog.com/1kt/simple/paging_dot.png) repeat-x scroll top center;
}
.blog-pager-older-link, .home-link,
.blog-pager-newer-link {
background-color: #ffffff;
padding: 5px;
}
.footer-outer {
border-top: 1px dashed #bbbbbb;
}
/* Mobile
----------------------------------------------- */
body.mobile  {
background-size: auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
.mobile .body-fauxcolumn-outer .cap-top {
background-size: 100% auto;
}
.mobile .content-outer {
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
}
.mobile .tabs-inner .widget ul {
margin-left: 0;
margin-right: 0;
}
.mobile .post {
margin: 0;
}
.mobile .main-inner .column-center-inner .section {
margin: 0;
}
.mobile .date-header span {
padding: 0.1em 10px;
margin: 0 -10px;
}
.mobile h3.post-title {
margin: 0;
}
.mobile .blog-pager {
background: transparent none no-repeat scroll top center;
}
.mobile .footer-outer {
border-top: none;
}
.mobile .main-inner, .mobile .footer-inner {
background-color: #ffffff;
}
.mobile-index-contents {
color: #666666;
}
.mobile-link-button {
background-color: #2288bb;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile .tabs-inner .section:first-child {
border-top: none;
}
.mobile .tabs-inner .PageList .widget-content {
background-color: #eeeeee;
color: #000000;
border-top: 1px solid #dddddd;
border-bottom: 1px solid #dddddd;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #dddddd;
}

--></style>
<style id='template-skin-1' type='text/css'><!--
body {
min-width: 960px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 960px;
max-width: 960px;
_width: 960px;
}
.main-inner .columns {
padding-left: 0;
padding-right: 310px;
}
.main-inner .fauxcolumn-center-outer {
left: 0;
right: 310px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0") -
parseInt("310px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0;
}
.main-inner .fauxcolumn-right-outer {
width: 310px;
}
.main-inner .column-left-outer {
width: 0;
right: 100%;
margin-left: -0;
}
.main-inner .column-right-outer {
width: 310px;
margin-right: -310px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
--></style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=5431247843063773408&amp;zx=c5337caf-4cee-48f3-80e7-7fffce15cfdc' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=5431247843063773408&amp;zx=c5337caf-4cee-48f3-80e7-7fffce15cfdc' rel='stylesheet'/></noscript>
</head>
<body class='loading variant-simplysimple'>
<div class='navbar section' id='navbar' name='Navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d5431247843063773408\x26blogName\x3dThe+Perl+Fisher\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dLIGHT\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttp://theperlfisher.blogspot.com/search\x26blogLocale\x3den\x26v\x3d2\x26homepageUrl\x3dhttp://theperlfisher.blogspot.com/\x26vt\x3d7355922028120212330',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div itemscope='itemscope' itemtype='http://schema.org/Blog' style='display: none;'>
<meta content='The Perl Fisher' itemprop='name'/>
</div>
<div class='body-fauxcolumns'>
<div class='fauxcolumn-outer body-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content'>
<div class='content-fauxcolumns'>
<div class='fauxcolumn-outer content-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content-outer'>
<div class='content-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left content-fauxborder-left'>
<div class='fauxborder-right content-fauxborder-right'></div>
<div class='content-inner'>
<header>
<div class='header-outer'>
<div class='header-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left header-fauxborder-left'>
<div class='fauxborder-right header-fauxborder-right'></div>
<div class='region-inner header-inner'>
<div class='header section' id='header' name='Header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
The Perl Fisher
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span>
</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class='header-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</header>
<div class='tabs-outer'>
<div class='tabs-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left tabs-fauxborder-left'>
<div class='fauxborder-right tabs-fauxborder-right'></div>
<div class='region-inner tabs-inner'>
<div class='tabs no-items section' id='crosscol' name='Cross-Column'></div>
<div class='tabs no-items section' id='crosscol-overflow' name='Cross-Column 2'></div>
</div>
</div>
<div class='tabs-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='main-outer'>
<div class='main-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left main-fauxborder-left'>
<div class='fauxborder-right main-fauxborder-right'></div>
<div class='region-inner main-inner'>
<div class='columns fauxcolumns'>
<div class='fauxcolumn-outer fauxcolumn-center-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-left-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-right-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class='columns-inner'>
<div class='column-center-outer'>
<div class='column-center-inner'>
<div class='main section' id='main' name='Main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>14 March 2018</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='2535161686434446832' itemprop='postId'/>
<a name='2535161686434446832'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2018/03/who-ordered-that-array.html'>Who ordered that (array)?</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-2535161686434446832' itemprop='description articleBody'>
<div>
You know how it is when coming back to some code after days, weeks or in this case, maybe even months away? I'm going through that right now, and thought I'd talk about one issue I just ran into. While reworking the actions for the ANTLR4 translator, I <b>really</b> don't want to rewrite the grammar. It passes the full ANTLR4 corpus, and I don't want to touch that.</div>
<br />
<div>
So I've just finished rewriting a bunch of tests, and am ready to capture ANTLR tokens so that I can rewrite them into Perl 6. The match object looks like this when you dump it ("dump" is a bit overblown - in other languages you might need a separate Dump() method, in Perl 6 "say $/" is all you need.):</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">prequelConstruct =&gt; &#65378;tokens { INDENT }&#65379;
 tokensSpec =&gt; &#65378;tokens { INDENT }&#65379;
  token_list_trailing_comma =&gt; &#65378;INDENT &#65379;
   tokenName =&gt; &#65378;INDENT&#65379;
    ID =&gt; &#65378;INDENT&#65379;</code></pre>
<br />
<div>
But when I started trying to capture the 'INDENT' text with <i>$/&lt;prequelConstruct&gt;&lt;tokensSpec&gt;&lt;token_list_trailing_comma&gt;</i>, I get this weird error:</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">Type Array does not support associative indexing.
  in method TOP at /home/jgoff/perl6-ANTLR4/lib/ANTLR4/Actions/Perl6.pm6 (ANTLR4::Actions::Perl6) line 88</code></pre>
<br />
<div>
But... but... it's just <i>prequelConstruct</i> containing a <i>tokensSpec</i> and so on, I don't see any arrays involved. Now, if I were using 'dd' rather than the built-in stringifier I'd probably see the problem right away. Unfortunately if you're using the default 'say $/' stringifier, there's no easy way to see what's going on. What's happening here is the <i>prequelConstruct</i> actually contains an <b>array</b> of matches, but the default 'say' output won't show you this.</div>
<br />
<div>
Thankfully, Perl 6, just like its sister Perl 5, encourages experimentation. If you back off and just use 'say $/&lt;prequelConstruct&gt;;', that will work. When you add '&lt;tokensSpec&gt;', which <b>looks like</b> what should be the next layer down, you'll get the 'Type Array...' error, which will tell you that <i>prequelConstruct</i> contains an array of stuff. 'dd' should tell you more clearly what portion of the match is an array, and what are hash keys, and I'd recommend using that to clarify what's going on. This is just a little posting to help people debug what I suspect is a common confusion.</div>
<br />
<div>
Thank you again, dear reader. Comments, clarifications and questions are of course welcome.</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2018/03/who-ordered-that-array.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2018/03/who-ordered-that-array.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2018-03-14T14:37:00+02:00'>14:37</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2018/03/who-ordered-that-array.html#comment-form' onclick=''>
No comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=2535161686434446832&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=2535161686434446832&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=2535161686434446832&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=2535161686434446832&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=2535161686434446832&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=2535161686434446832&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2018/03/who-ordered-that-array.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>11 January 2018</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='8789770563021161940' itemprop='postId'/>
<a name='8789770563021161940'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2018/01/abusing-multiple-dispatch-creatively.html'>Abusing multiple-dispatch creatively</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-8789770563021161940' itemprop='description articleBody'>
<div>
As part of creating a new POD tree for the Perl 6 utilities in hopes of letting others create their own subclasses, I came across this interesting use of multiple-dispatch. One of the Pod types that the Perl 6 compiler generates is for inline attributes like making <b>text bold</b> or <i>italic</i> with formatting codes like 'B&lt;text bold&gt;'. Bold, italic, and underline formatting codes all generate the same <i>Pod::FormattingCode</i> object, with a different <i>.type</i> value, so they look something like</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">class Pod::FormattingCode {
  has Str $.type; # This is 'B', 'I', etcetera as the need arises.
}
class Pod::FormattingCode::Bold { }</code></pre>
<br />
<div>
I have a bunch of <i>.to-node()</i> methods that are specialized on turning raw Pod objects into something a little more useful. One of these, to convert a <i>Pod::FormattingCode</i> into my internal <i>Node::FormattingCode::Bold</i> object, looks like this:</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">multi method to-node( Pod::FormattingCode $pod ) {
  given $pod.type {
    when 'B' {
      Node::FormattingCode::Bold.new( :type( $pod.type ) )
    }
  }
}

my $bold = Pod::FormattingCode.new( :type( 'B' ) );
self.to-node( $bold ); # Calls the multi method above.
</code></pre>
<br />
<div>
All of the methods that convert $something to a node are named <i>.to-node()</i>, and I can rely on Perl 6's multiple dispatch to keep them separate for me. This is important to me mainly because of locality of reference. If you're debugging my code, and you want to know where something gets converted to a <i>Node::</i> object, just look through the <i>.to-node()</i> methods. Now, looking at the <i>given-when</i> block, that's going to grow, and by quite a bit. At least three lines for every formatting code that I find in the documentation.</div>
<br />
<div>
And it gets a bit worse. Say I want to do the right thing, and factor out the  '.new(...)' lines into their own method, because I'm pretty sure they'll grow, as I find neat little corner cases for each of the Pod types. I'd have to name them something ugly, which breaks up my idea.</div>
<br />
<div>
Since the method still converts a <i>Pod</i> object to a <i>Node</i> object, it'd be nice to be able to reuse the <i>.to-node()</i> method, but to fit it into the existing scheme of things I"d have to create a new object like a <i>Pod::FormattingCode::Bold</i>, create a new instance of that, and then I'd be able to do multiple-dispatch on <b>that</b> type. But that means creating not one but <b>two</b> new classes for every <i>Pod::FormattingCode</i> - one for the "shim" that I use to dispatch on, and another one for the actual object I'm going to return to the user. And it's even <b>worse</b> than that, because it's possible, though very unlikely, that the Perl 6 team will one day create a <i>Pod::FormattingCode::Bold</i> class and trounce on my own name-space, undoing my hard work.</div>
<br />
<div>
Well, as you might have guessed, there <b>is</b> a solution, and it doesn't involve trouncing on anyone's namespaces. And it <b>still</b> lets us stick to the principle of reusing <i>.to-node()</i> for all of our node-conversion needs. Here's how you write it:</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">multi method to-node( Pod::FormattingCode $pod ) {
  self.to-node( $pod, $pod.type );
}
multi method to-node( Pod::FormattingCode $pod, 'B' ) {
  Node::FormattingCode::Bold.new( :type( 'B' ) );
}

my $bold = Pod::FormattingCode.new( :type( 'B' ) );
self.to-node( $bold ); # Returns a Node::FormattingCode::Bold object.
</code></pre>
<br />
<div>
What this does may not be obvious at first glance, so I'll walk through it. We create a <i>Pod::FormattingCode</i> object of type 'B' for Bold, and magic happens. The first magical bit is that multiple-dispatch kicks in, so that when <i>.to-node()</i> gets called, Perl 6 does its best to find the closest signature. And in this case it's a perfect match. <i>.to-node( Pod::FormattingCode )</i> is perfectly matched by the first method. Inside <b>that</b> method, we do something a little sneaky. We break out the type, and rely <b>again</b> on multiple dispatch. This time we're calling <i>.to-node( Pod::FormattingCode $pod, 'B' )</i>, and <b>again</b> we have a perfect match, but this time it's the second method, down below. That creates the new <i>Node::FormattingCode::Bold</i> object and returns it.</div>
<br />
<div>
How did that work, you might ask? Well, multiple dispatch in languages like C++ or Java work based on types. You can <b>sort of</b> simulate what we just did in C++ with templates, and Java's generic <b>sort of</b> do what we did, but not quite, and with much more work. TL;DR Perl 6's multiple dispatch works on argument <b>values</b> as well as types, so you can dispatch both on a generic <i>Str</i> class as well as a specific instance "foo" of <i>Str</i>. This means you can write Haskell-like code in Perl 6.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">multi sub fib( $n where * &lt; 0 ) { 0 }
multi sub fib( 0 ) { 0 }
multi sub fib( 1 ) { 1 }
multi sub fib( $n ) { fib( $n - 1 ) + fib( $n - 2 ) }
</code></pre>
<br />
<div>
The <i>where</i> declaration there lets us cleanly handle negative values as well, as a bonus. No matter what (integer) value the client passes to the <i>fib</i> subroutine, Perl 6 will dispatch it cleanly, so that <i>fib(2)</i> will call <i>sub fib(1)</i> and return 1, rather than calling <i>sub fib($n)</i> and going into an infinite regress. I was just working along on <i>Pod::To::Tree</i>, did that particular bit of refactoring and thought you might like to hear about it. This is your friendly neighborhood Perl Fisher, signing off.</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2018/01/abusing-multiple-dispatch-creatively.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2018/01/abusing-multiple-dispatch-creatively.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2018-01-11T22:14:00+02:00'>22:14</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2018/01/abusing-multiple-dispatch-creatively.html#comment-form' onclick=''>
No comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=8789770563021161940&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8789770563021161940&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8789770563021161940&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8789770563021161940&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8789770563021161940&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8789770563021161940&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2018/01/abusing-multiple-dispatch-creatively.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>07 January 2018</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='8556508416299443862' itemprop='postId'/>
<a name='8556508416299443862'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2018/01/tree-surgery.html'>Tree Surgery</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-8556508416299443862' itemprop='description articleBody'>
<div>
HTML and I tend to get along like a house on fire. I can work with it when
the need arises, but I still prefer to do semantic markup and let CSS do with
it what the end-user wants to see, which these days is shiny sidebars,
blogroll posts and code blocks that neatly let the user just drag-and-select
the text they want and copy it into their editor of choice.</div>
<br />
<div>
As you can see by this posting, I haven't quite gotten there yet. Equally,
you can see that I haven't given up altogether, because I'm still here, posting
and tweaking things. A couple of months ago (okay, it just <b>feels</b> that
way) I figured out that it'd be much simpler for me to take a Perl 6 POD
document and add the markup that I need to that.</div>
<br />
<div>
After some pondering I realized "Wait, isn't there already a Perl 6 POD
converter out there? Called <i>perl6 --doc</i>? And can't I re-purpose what it
does to generate Blogspot-ready HTML?"</div>
<br />
<div>
<a href="https://github.com/perl6/Pod-To-HTML">Pod::To::HTML</a> already is
out there, but the way the code is written made it hard if not impossible to
subclass, because most of the important stuff was inside <i>sub</i> blocks, not
out in <i>method</i>s where they could easily be sub-classed.</div>
<br />
<div>
So I started rewriting it. A few days later, after grumbling and wondering
why <b>this</b> particular bit had been written the way it was, I went onto
the usual suspect <a href="https://perl6.org/community/irc">Perl IRC</a>
channel where the author likely hung out, so I could get a useful answer. He
wasn't around, but someone pointed me to another module,
<a href="https://github.com/houseabsolute/perl6-Pod-TreeWalker">Pod::TreeWalker</a>,
and told me that he too was interested in fixing this.</div>
<br />
<div>
So, as things happen, conversation started. I rewrote the guts of what I had
with <a href="https://github.com/houseabsolute/perl6-Pod-TreeWalker">Pod::TreeWalker</a>,
and found that it did some things I really didn't want it to. All I wanted...
hoo boy. I know that phrase all too well, it usually means I'm going to end up
rewriting some module only to run into the problems <b>they</b> encountered.
Well, once more into the breach, and all that.</div>
<br />
<div>
So, I decided that while I liked <a href="https://github.com/houseabsolute/perl6-Pod-TreeWalker">Pod::TreeWalker</a>'s
style - it's an event-driven system, it did place some limitations on how
you could work with it. For example, when a pod-table-start event came along,
it was pretty easy to figure out "Hey, this is the start of a POD table, so I
can generate a `&lt;table&gt;' string and add it to my running HTML." And this
worked fine, for all of about 20 minutes. Because it also generated other
events in places where I didn't think it should, such as paragraphs inside a
list item, which made the generated HTML look odd.</div>
<br />
<div>
For instance,</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">=item foo</code></pre>
<br />
<div>
generates this sequence, when marshalled back out to HTML:</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">&lt;li&gt;&lt;p&gt;foo&lt;/p&gt;&lt;/li&gt;</code></pre>
<br />
<div>
What's happening here is that the library sends out:</div>
<ul>
<li>An 'item-start' event, so I tack on '&lt;li&gt;' to the HTML.</li>
<ul>
<li>A 'paragraph-start' event, so I tack on '&lt;p&gt;' to the HTML.</li>
<li>A 'text' event, with 'foo' as the txt, so I tack on 'foo'.</li>
<li>A 'paragraph-end' event, so I tack on '&lt;/p&gt;' to the HTML.</li>
</ul>
<li>An 'item-end' event, so I tack on '&lt;/li&gt;' to the HTML.</li>
</ul>
<div>
Now, as I've mentioned earlier, I didn't particularly like the fact that
the sequencer created a paragraph event, when there's no particular need to
do so. But I'm stuck with it. I still have possibilities, though. I can...</div>
<ol>
<li>Post-process the HTML and do a quick regex to remove the &lt;p&gt;..&lt;/p&gt; tags, but, and repeat after me, friends don't let friends run regex on HTML.</li>
<li>When a 'paragraph-start' event is encountered, see if the HTML has &lt;li&gt; already there, and ignore it if so. But see #1.</li>
<li>Hack the module to pass along the "parent" event when firing off an event, so I could look at the "parent" event and if that's a paragraph, ignore it.</li>
<li>Wait a minute, parent... &lt;digs_through_source/&gt; it's already got a
tree of POD it's walking, if I pull out just the tree, then it's actually
<b>less</b> code to walk the tree, and when I encounter the &lt;p&gt; node I can tell it to look at its parent... right.</li>
</ol>
<div>
Armed with this realization, I sally forth. Lucky for me, Perl 6 POD is
already laid out as a tree, so it's pretty simple to start walking it. Now,
there are a bunch of straightforward ways to write a walker like this, but I
rather prefer to use the multiple-dispatch features of Perl 6 for this purpose.
</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">method walk( $node ) {
  self.visit( $node );
  if $node.^can('contents') {
    for @( $node.contents ) -&gt; $child {
      self.walk( $child );
    }
  }
}
</code></pre>
<br />
<div>
POD nodes are laid out in a pretty simple fashion. They're either "leaves"
like text blocks (our infamous paragraph contents) or they're shells, like a
list of items. An easy way to tell whether a node is a leaf or not is whether
it has 'contents', and we do that by the "^can('contents')" test. Just calling
the method directly would work as well, but every time we called it on a leaf
node, we'd get a runtime error. Not good.</div>
<br />
<div>
Once you know that bit, the code sort of falls into place.</div>
<ul>
<li>Visit $node (AKA "do something with it", like print its text)</li>
<li>If it's got children:</li>
<ul>
<li>For each child (that's the "@( $node.contents ) -&gt; $child" bit)</li>
<li>Walk over that child.</li>
</ul>
</ul>
<div>
So your user-declared <i>visit()</i> method will get called once on every
node in the entire tree, in a depth-first search, so it's in the perfect order
to return HTML to you. Well, almost, but the exceptions aren't worth talking about.</div>
<br />
<div>
Great, we can walk the tree in depth-first order, and we've got a handy
<i>visit()</i> method that'll do something. We can even add a <i>$.html</i> attribute that we can accumulate our HTML into as we go along, problem solved!</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">has Str $.html;
method visit( $node ) {
  if $node ~~ Pod::Table {
    $.html ~ '&lt;table&gt;'; # .. hey, wait a minute...
  }
}
</code></pre>
<br />
<div>
Hold the phone, this just tells me when we've encountered, say, a Table
node. I wanted to be able to write something when a table starts, and when it
ends. And I wanted to know what the table's parent was, like we talked about
lo those many paragraphs ago.</div>
<br />
<div>
No worries, we're really close, honest. I'll change the <i>walk()</i> method
just to show you.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">method walk( $node, $parent = Nil ) {
  self.start-node( $node, $parent );
  if $node.^can('contents') {
    for @( $node.contents ) -&gt; $child {
      self.walk( $child, $node );
    }
  }
  self.end-node( $node, $parent );
}
</code></pre>
<br />
<div>
The '= Nil' is a handy shortcut so that you can call the <i>walk()</i>
without having to specify a Nil parent. In your code you can just call
<i>walk($pod)</i> without anything special, Perl 6 will just fill in the missing
argument for you.</div>
<br />
<div>
Also, you'll see that the generic <i>visit()</i> call is gone, there's now
in its place a <i>start-node($node,$parent)</i> and <i>end-node($node,$parent)</i> call. We can easily use them like this:</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">has $.html;
method start-node( $node, $parent ) {
  given $node {
    when Pod::Table { $!html ~= '&lt;table&gt;' }
  }
}
method end-node( $node, $parent ) {
  given $node {
    when Pod::Table { $!html ~= '&lt;/table&gt;' }
  }
}
</code></pre>
<br />
<div>
And voilá! <i>start-node()</i> gets called when a table starts, and its
companion <i>end-node()</i> gets called after all of the table contents are
displayed, so we can write in the '&lt;/table&gt;' tag at the right time. And
we can even check out the table's parent node at <i>$parent</i>. If there isn't
one, then we're at the top of the tree!</div>
<br />
<div>
There are a few minor downsides to this, though. For one, every time we
learn about a new Pod node, we're going to have to update both the
<i>start-node()</i> and <i>end-node()</i> method. But we can fix that simply.
Perl 6 lets us dispatch methods by type, using the <i>multi</i> keyword. So,
let's try that.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">has $.html;
method start-node( Pod::Table $node, $parent ) { $!html ~= '&lt;table&gt;' }
method end-node( Pod::Table $node, $parent ) { $!html ~= '&lt;/table&gt;' }
</code></pre>
<br />
<div>
Much less noise, and Perl 6 will know exactly how to dispatch our types.
But when the code out in the wild encounters a new Pod node that we didn't know
about, it'll break with a horrible stacktrace, so let's fix that right now.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">has $.html;
method start-node( $node, $parent ) { die "Unknown node " ~ $node.^WHAT.perl }
method end-node( $node, $parent ) { die "Unknown node " ~ $node.^WHAT.perl }
</code></pre>
<br />
<div>
There, now our code will gracefully die when it's encountered a node that it's never seen before, and report exactly what the node is so that when someone
makes a bug report on GitHub we'll know what to do.</div>
<br />
<div>
Now, I should reveal that my upcoming
<a href="https://github.com/drforr/perl6-Pod-To-HTMLBody.git">Pod::To::HTMLBody</a>
module doesn't quite work like this. I do use some of these techniques behind
the scenes, and ultimately I walk the tree almost exactly in the same way, but
I've done things differently for several different reasons. I guess you'll have
to wait for the next part of this article to learn what's going on, and what
new challenges I faced making this particular module.</div>
<br />
<div>
Until then, this is your humble author signing off.</div>
<br />
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2018/01/tree-surgery.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2018/01/tree-surgery.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2018-01-07T15:49:00+02:00'>15:49</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2018/01/tree-surgery.html#comment-form' onclick=''>
No comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=8556508416299443862&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8556508416299443862&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8556508416299443862&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8556508416299443862&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8556508416299443862&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=8556508416299443862&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2018/01/tree-surgery.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>26 November 2017</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='5371932537509691352' itemprop='postId'/>
<a name='5371932537509691352'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2017/11/test-all-things.html'>Test All The Things</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-5371932537509691352' itemprop='description articleBody'>
<div>
Is this thing on? Hello? Great, you can see me. This time is all about unit testing in Perl 6. Are you curious about what that t/ directory is for, and want to fill that empty space with some test files? You've come to the right post. If you don't know what I'm talking about, now might be a good idea to go look at a few <a href="https://modules.perl6.org/" target="_blank">Perl 6 modules</a> and check out the testing directory.</div>
<br />
<div>
Perl has a long tradition of extensive test suites for its modules, and Perl 6 continues that tradition. You can start by downloading a module from GitHub following the <a href="https://modules.perl6.org/" target="_blank">Perl 6 modules</a> link and checking out its t/ directory.</div>
<br />
<div>
Perl 6 comes with a built-in <a href="https://docs.perl6.org/language/testing">Test</a> module, which looks a lot like Perl 5's Test::More module. I'm not going to go into great detail (in this post, at least) about what all the methods do, I'm going to focus on just two or three ideas that I came up with when writing my own test suites.</div>
<br />
<div>
DRYing out your tests</div>
<br />
<div>
Sometimes you get into the zone writing tests, and your tests start to bunch up.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">is sprintf( "%s", "a" ), "a", "'a' roundtrips.";
is sprintf( "%s", "&#8364;" ), "&#8364;", "'&#8364;' roundtrips.";
is sprintf( "%s", "\x[263a]" ), "\x[263a]", "Smiley roundtrips.";
</code></pre>
<br />
<div>
While something of a contrived example, it's pretty obvious that all of these tests should be bundled together. You certainly could put them in their own file, and in this case it might be a good idea because being able to roundtrip strings (make sure that the input is the same as the output) needs some pretty thorough testing.</div>
<br />
<div>
Right now, though, as it stands, three lines hardly is worth the effort to think of a new name for the file, copy to the new location, delete the old content, add it to git and do a push. Let's come up with an easier way to group these.</div>
<br />
<div>
Visually separating them with a block certainly works...</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">{
  is sprintf( "%s", "a" ), "a", "'a' roundtrips.";
  is sprintf( "%s", "&#8364;" ), "&#8364;", "'&#8364;' roundtrips.";
  is sprintf( "%s", "\x[263a]" ), "\x[263a]", "Smiley roundtrips.";
}
</code></pre>
<br />
<div>
While it certainly looks better, it doesn't help the repetition any. "roundtrips" still repeats, and every time we come up with a new string that might break <i>sprintf()</i> we've got to add it in three places. Let's tackle that first, before going on to the final round.</div>
<br />
<div>
It's certainly tempting to write a quick subroutine to do this, so let's dash off one.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">sub roundtrip( $name ) {
  is sprintf( "%s", $name ), $name, "'$name' roundtrips."
}
{
  roundtrip( "a" );
  roundtrip( "&#8364;" );
  roundtrip( "\x[263a]" );
}
</code></pre>
<br />
<div>
Yippee! We've eliminated almost all of the redundancy, and our test output still works!</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">ok 1 - 'a' roundtrips.
ok 2 - '&#8364;' roundtrips.
ok 3 - '&#9786;' roundtrips.
</code></pre>
<br />
<div>
There's a problem lurking here, though. A couple, actually. What happens when <i>sprintf()</i> breaks?</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">ok 1 - 'a' roundtrips.
not ok 2 - '&#8364;' roundtrips.
# Failed test ''&#8364;' roundtrips.'
# at t/10-sprintf.t line 4
ok 3 - '&#9786;' roundtrips.
</code></pre>
<br />
<div>
Pretending we're in a hurry and this is just one of a number of problems we have to debug this evening (just like in real life), open your editor and go to line 4 to quickly trace down the bug...</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">use Test;

sub roundtrip( $name ) {
  is sprintf( "%s", $name ), $name, "'$name' roundtrips." # line 4
}
{
  roundtrip( "a" );
  roundtrip( "&#8364;" );
  roundtrip( "\x[263a]" );
}
</code></pre>
<br />
<div>
Hold the phone here, I expected to jump to the test that failed, and I'm on a test subroutine! This would get even more confusing if I had a test library, and <i>roundtrip()</i> wasn't even in my test file. It'd be even a bit confusing if I just saw the word 'roundtrip' repeated over and over, and just searched for that. Or even worse, imagine that this is a file with 200+ tests in it, and every tenth test is for a low Unicode character, so you've got to page through 20 different tests 'til you find the right one. There's got to be a better way.</div>
<br />
<div>
Now you could certainly throw away your changes, roll back to the point where you refactored and call the time a waste. It's easy enough to salvage, though.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">use Test;

sub roundtrip( $name ) {
  sprintf( "%s", $name )
}
{
  is roundtrip( "a" ), "a", "'a' roundtrips.";
  is roundtrip( "&#8364;" ), "&#8364;", "'&#8364;' roundtrips.";
  is roundtrip( "\x[263a]" ), "\x[263a]", "'\x[263a]' roundtrips.";
}
</code></pre>
<br />
<div>
This solves the problem, so when an <i>is()</i> test fails, we'll get pointed directly at the line number, and can jump there in Atom, Emacs, Vim or whatever. But we've gotten our duplication back. Let's try to refactor our way out of this, while making sure that we don't put the <i>is()</i> back into the helper <i>roundtrip()</i> subroutine.</div>
<br />
<div>
We'll start by noting that <i>is( $string, $roundtripped )</i> (ignoring the <i>$message</i> parameter) is equivalent to <i>ok( $string eq $roundtripped )</i>. Change the test from <i>is()</i> to <i>ok()</i> first, then add <i>eq $name</i> inside <i>roundtrip()</i>, and get rid of the redundant argument.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">use Test;

sub roundtrip( $name ) {
  sprintf( "%s", $name ) eq $name
}
{
  ok roundtrip( "a" ), "'a' roundtrips.";
  ok roundtrip( "&#8364;" ), "'&#8364;' roundtrips.";
  ok roundtrip( "\x[263a]" ), "'\x[263a]' roundtrips.";
}
</code></pre>
<br />
<div>
That's pretty good, but there's a constant 'roundtrips.' string there. Also we've got this <i>{..}</i> block that's unused, so let's put that block to work by factoring out the 'roundtrips.' bit, using <i>subtest {..}</i>.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">use Test;

sub roundtrip( $name ) {
  sprintf( "%s", $name ) eq $name
}
subtest 'roundtrips', {
  ok roundtrip( "a" ), "'a'";
  ok roundtrip( "&#8364;" ), "'&#8364;'";
  ok roundtrip( "\x[263a]" ), "'\x[263a]'";
};
</code></pre>
<br />
<div>
Looking good, but we've lost a bit along the way. Earlier, when we ran our test suite, we'd get nicely labeled output. Now... not so much.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">  ok 1 - 'a'
  ok 2 - '&#8364;'
  ok 3 - '&#9786;'
ok 1 - roundtrips
</code></pre>
<br />
<div>
In a simple, short file like this, scanning from the <i>ok 1 - 'a'</i> line, thinking "Okay, why are we testing 'a'?... Aha, roundtrip tests." is pretty quick, and the indentation tells us we're grouping a bunch of tests, but it would be <b>really</b> nice to be able to put that test message where it belongs, in the roundtrip message. So let's do just that.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">use Test;

sub roundtrip( $name ) {
  sprintf( "%s", $name ) eq $name, "'$name' roundtrips."
}
subtest 'roundtrips', {
  ok roundtrip( "a" );
  ok roundtrip( "&#8364;" );
  ok roundtrip( "\x[263a]" );
};
</code></pre>
<br />
<div>
Great, we've got just one test function that tests and gives us a message! Let's run it!</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">  ok 1 -
  ok 2 -
  ok 3 -
ok 1 - roundtrips
</code></pre>
<br />
<div>
What's going on here? <i>roundtrip()</i> returns both the truthiness of our test and the message correctly, you can test that on the command line yourself. Yes, Virginia, Perl 6 subroutines <b>can</b> return more than one value - <i>perl6 -e'sub test { "foo", "bar" }; say test();'</i> will return <i>[ foo bar ]</i> as you'd expect.</div>
<br />
<div>
So <i>ok()</i> is getting the list that <i>roundtrip()</i> returns, and should be unpacking that list and...hey, waitaminnit. <i>roundtrip()</i> returns a list, and <i>ok()</i> expects one argument and one optional argument... maybe <b>that's</b> what's going wrong here. So, how do we solve this?</div>
<br />
<div>
Luckily for us, there's an easy way to unpack our list into two arguments. It's not <b>quite</b> destructuring (there's another way to do that) but it works for us. The <b>| (pipe)</b> symbol before a list "expands" that list inline into a bunch of individual arguments, so let's put that before the <i>roundtrip()</i> call and unpack the list.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">use Test;

sub roundtrip( $name ) {
  sprintf( "%s", $name ) eq $name, "'$name' roundtrips."
}
subtest 'roundtrips', {
  ok |roundtrip( "a" );
  ok |roundtrip( "&#8364;" );
  ok |roundtrip( "\x[263a]" );
};
</code></pre>
<br />
<div>
And rerunning our test suite now, our output is what we expect.</div>
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">  ok 1 - 'a' roundtrips.
  ok 2 - '&#8364;' roundtrips.
  ok 3 - '&#9786;' roundtrips.
ok 1 - roundtrips
</code></pre>
<br />
<div>
This may be a bridge too far for some, and I respect your decision. Using the <i>subtest()</i> block may be all you need, because you can quickly search for a keyword in the string and bounce immediately to the start of the tests where one fails. You may even want to go to the lengths of using <code>ok( roundtrip($_) ) for &lt; a &#8364; &#9786; &gt;</code> to get rid of the last duplicated call to <i>roundtrip()</i>, that's your choice. all I'm offering here is some ways to DRY out your test files.</div>
<br />
<div>Gentle Reader, if you've gotten this far, thank you. I do read all the comments that I get, at least eventually. I'm also @DrForr on Twitter, 'Jeff Goff' on Facebook and LinkedIn. Thank you for your time, and I hope it was worth your while.</div>

<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2017/11/test-all-things.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2017/11/test-all-things.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2017-11-26T22:34:00+02:00'>22:34</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2017/11/test-all-things.html#comment-form' onclick=''>
3 comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=5371932537509691352&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=5371932537509691352&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=5371932537509691352&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=5371932537509691352&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=5371932537509691352&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=5371932537509691352&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2017/11/test-all-things.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>19 April 2017</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='9223349740490587263' itemprop='postId'/>
<a name='9223349740490587263'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2017/04/wrangling-metadata-right-way.html'>Wrangling Metadata the Right Way</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-9223349740490587263' itemprop='description articleBody'>
If you're new to Regular Expressions or Grammars (at least as they're used in Perl 6), then I'd suggest starting with&nbsp;<a href="http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt.html" target="_blank">the 1st part</a>&nbsp;of a full tutorial on Perl 6 grammars. Now to the heart of the matter!<br />
<br />
I'm rewriting the ANTLR -&gt; Perl 6 grammar translator, and the code was simply too old to really be refactored - it predated the Great List Refactor, ask any old Perl 6 hand about that. This <b>does</b> require some familiarity with how grammars and Abstract Syntax Trees are related, so please bear with me.<br />
<div>Grammar rules (rules that tell Perl 6 how you want to match text) look something like:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">rule parserRuleSpec
        {
        &lt;ID&gt;
        ':'
        &lt;parserAltList&gt;
        ';'
        }
</code></pre>
<div>Here an &lt;ID&gt; is simply the name of a parser rule, and &lt;parserAltList&gt; is its body, consisting of a series of "alternations". Like YACC, Marpa or ANTLR, you can tell Perl 6 to run a block of code when it successfully parses a &lt;parserRuleSpec&gt; in the target string. Let's assume that our target looks like:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">integer : \d+ ;</code></pre>
<div>Even if you don't know the exact details, it shouldn't be hard to guess that &lt;ID&gt; matches 'integer', and &lt;parserAltList&gt; matches '\d+'. If you don't ask Perl 6 to do anything to this, the 'integer' and '\d+' bits tend to sort of get lost in what can look like a confusing blizzard of hashes and arrays, it certainly was confusing to me. But we can help make sense of all of this. When this particular rule succeeds, we can stop right <b>there</b> and do something useful with that data. It'd be nice to get back a neat little hash, with some consistently-named keys, so we can do something like this:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">method parserRuleSpec( $/ )              # rule parserRuleSpec
        {                                #         {
        make {                           #
             name =>                     #
                 $/&lt;ID&gt;.Str,             #         &lt;ID&gt;
                 # ':'                   #         ':' 
             body =>                     #
                 $/&lt;parserAltList&gt;.Str   #         &lt;parserAltList&gt;
                 # ';'                   #         ';'
             }                           #
        }                                #         }
</code></pre>
<div>[If this doesn't render neatly, my apologies, but I wanted to make it clear what I've done.] I've added a parserRuleSpec() method that will be run whenever the parser completely and correctly matches a parserRuleSpec rule. Whenever I want to inspect a parserRuleSpec rule, I don't have to dig around inside Match objects and look for strings, all I need to do is something like 'say $/&lt;parserRuleSpec&gt;.ast.gist' and now I'll get a nice simple representation of a parserRuleSpec as a hash with 'name' and 'body' keys:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say $/&lt;parserRuleSpec&gt;.ast.gist;

# {name => 'integer', body => '\d+'}
</code></pre>
<div>So our potentially-gnarly parserRuleSpec is now tamed, and resides in a nice neat data structure. And if you note, it's a pretty mechanical process. Copy the original rule, change 'rule' to 'method', wrap with 'make { }', and give names to the &lt;ID&gt; etc. tags. In fact, you could probably automate it, but that's another article for another time :) My point here is that you don't always want this kind of routinely-generated data structure.</div><br />
<div>If you have a rule like 'integer : \d+ ;', then it's not unreasonable to assume that other rules will follow, like 'float : \d+ "." \d+ ;'. Eventually, you'll want to collect these into some other data structure, maybe like this:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my %rules;
for $/&lt;parserRules&gt; -&gt; $rule
        {
        %rules{ $rule.&lt;name&gt; } = $rule.&lt;body&gt;;
        }
say %rules.gist;

# {integer =&gt; '\d+', float =&gt; '\d+ "." \d+'}
</code></pre>
<div>Or you could even write it more compactly:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my %rules;
%rules{ $_.&lt;name&gt; } = $_.&lt;body&gt; for $/&lt;parserRules&gt;;
say %rules.gist;

# {integer =&gt; '\d+', float =&gt; '\d+ "." \d+'}
</code></pre>
<div>There are of course other ways to write this, but there's another way altogether to avoid the complications. When I started out on this current project (early last year, as it happens) I was of the opinion that the AST return blocks should contain all of the information they needed, so that I never had to "go back" for more data. During the rewrite I realized that's not necessarily the case, and I can make things more flexible in this case by simply not returning the name as part of the AST, and letting the outer layer do what it wants with the actual name. So, this code now looks like: (skipping the original rule declaration)</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">method parserRuleSpec( $/ )
        {
        make $/&lt;parserAltList&gt;.Str
        }

my %rules;
for $/&lt;parserRules&gt; -&gt; $rule
        {
        %rules{ $rule&lt;ID&gt>.Str } = $rule.ast;
        }
say %rules.gist;

# {integer =&gt; '\d+', float =&gt; '\d+ "." \d+'}
</code></pre>
<h3>A bit of philosophy, if I may</h3>
<div>There are two subtle points to be made about this. The first is that I'm separating the metadata (just the name, but ANTLR decorates rules with other things) from the meat of the rule, so that the user doesn't have to wade through as much detail initially. When the user wants to look at the rule, a simple 'say $rule.ast.gist' will give them an idea of what the rule contains, without a blizzard of metadata like actions and exceptions.</div><br />
<div>Second, and more subtle, as the author of the code I don't have to care about what's <b>in</b> a rule, I just have to grab the .ast and return it. Say, for instance, I got halfway through coding these rules up, and realized that alongside the 'content' I needed to pass an action parameter as well, so</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my %rules;
for $/&lt;parserRules&gt; -&gt; $rule
        {
        %rules{ $rule.&lt;name&gt; } = $rule.&lt;body&gt;;
        }
say %rules.gist;

# {integer =&gt; '\d+', float =&gt; '\d+ "." \d+'}
</code></pre>
<div>now had to have an 'action' hash key added:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my %rules;
for $/&lt;parserRules&gt; -&gt; $rule
        {
        %rules{ $rule.&lt;name&gt; } = # If only this were $rule.ast...
            {
            body =&gt; $rule.&lt;body&gt;,
            action =&gt; rule.&lt;action&gt;
            };
        }
say %rules.gist;

# {integer =&gt; {body =&gt; '\d+', action =&gt; '$int-count++'}, float =&gt; {body =&gt; '\d+ "." \d+', action =&gt; '$float-count++'}}
</code></pre>
<div>Now, every time I want to add a <b>new</b> argument alongside 'body', I have to add it in at least two places - the original method that generated the .ast data structure, and the place in the driver code where I capture the data and store it in a higher-level .ast data structure. Actually I've forgotten about the test code (sigh, yes, <b>again</b>) so make that three places. And the documentation makes at least four. Those last two don't count as much because no matter what you do you've got to update test data, and if your test suite didn't catch the change, it really shouldn't be called a test suite unless you're doing some very specific black-box testing.</div><br />
<br />
<h3>In conclusion</h3>
<div>After this long writeup I'm going to go back to the ANTLR4 test bed with an eye towards eliminating this redundancy. The idea of capturing everything I needed in a grammar layer in a single pass appealed to me when I was first starting to write this, and I imagine the idea of "one grammar rule returns one AST hash" has some appeal. It's of course not as simple, especially since grammar rules can match optional things, match X or Y or Z but not all, and so on, but knowing that everything you need is in a single hash is handy when you're starting out, but I'm now seeing this as a counterexample to the KISS (Keep It Simple, you Silly thing) principle, and am going to check in the current ANTLR layer and refactor with this in mind before doing more work.</div>
<div>Gentle Reader, if you've gotten this far, thank you. I do read all the comments that I get, at least eventually. I'm also @DrForr on Twitter, 'Jeff Goff' on Facebook and LinkedIn. Thank you for your time, and I hope it was worth your while.</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2017/04/wrangling-metadata-right-way.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2017/04/wrangling-metadata-right-way.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2017-04-19T00:13:00+03:00'>00:13</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2017/04/wrangling-metadata-right-way.html#comment-form' onclick=''>
No comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=9223349740490587263&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=9223349740490587263&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=9223349740490587263&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=9223349740490587263&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=9223349740490587263&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=9223349740490587263&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2017/04/wrangling-metadata-right-way.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>28 February 2016</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='6825670793909763328' itemprop='postId'/>
<a name='6825670793909763328'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_28.html'>From Regular Expressions to Grammars, Pt. 4</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-6825670793909763328' itemprop='description articleBody'>
If you're new to Regular Expressions (at least as they're used in Perl 6), then I'd suggest starting with&nbsp;<a href="http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt.html" target="_blank">the 1st part</a>&nbsp;of this series. Those of you with a solid grasp of regular expressions may want to skip ahead to&nbsp;<a href="http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_20.html" target="_blank">last week's</a>&nbsp;posting. Now, on with the show!<br />
<br />
<h2>
In Last Week's Episode</h2>
<div>
We were starting to develop a compiler in Perl 6 that would take a JavaScript expression like</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> var a = 3; console.log( "Hey, did you know a = " + a + "?" );  
</code></pre>
and turn it into Perl 6 code that compilers like <a href="http://perl6.org/" target="_blank">Rakudo Perl</a>&nbsp;can run. Before we get started it's probably a good idea to figure out what that code will look like. If you already know Perl 5, then code like this should look familiar to you.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my $a = 3;
say "Hey, did you know a = " ~ $a ~ "?";</code></pre>
We'll need to make sure that our regular expressions have captured the essence of the JavaScript. If you remember from last time, we captured our text with this set of regular expressions:<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule Number { \d+ };
my rule Variable { \w+ };
my rule String { '"' &lt;-[ " ]&gt;+ '"' };
my rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
my rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };

say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' }</code></pre>
If you put this into a Perl 6 source file and run it, the output might look a little strange at first:<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">&#65378;var a = 3; console.log( "Hey, did you know a = " + a + "?" );&#65379;
&nbsp;Assignment-Expression =&gt; &#65378;var a = 3&#65379;
&nbsp; &nbsp; Variable =&gt; &#65378;a &#65379;
&nbsp; &nbsp; Number =&gt; &#65378;3&#65379;
&nbsp;Function-Call =&gt; &#65378;console.log( "Hey, did you know a = " + a + "?" )&#65379;
&nbsp; &nbsp; String =&gt; &#65378;"Hey, did you know a = " &#65379;
&nbsp; &nbsp; Variable =&gt; &#65378;a &#65379;
&nbsp; &nbsp; String =&gt; &#65378;"?" &#65379;
</code></pre>
If you'll ignore the &#65378;&#65379; marks for the moment, you can see that the matches are indented, almost like a file explorer window, with 'Assignment-Expression' being a directory, and 'Variable' and 'Number' being files inside that directory. That's not too far from the truth, actually. When I see this sort of structure, I find that it helps to visualize it like so, with just a bit of added syntax -<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">$/ =&gt; &#65378;var a = 3; console.log( "Hey, did you know a = " + a + "?" );&#65379;
&nbsp;&lt;Assignment-Expression&gt; =&gt; &#65378;var a = 3&#65379;
&nbsp; &nbsp; &lt;Variable&gt; =&gt; &#65378;a &#65379;
&nbsp; &nbsp; &lt;Number&gt; =&gt; &#65378;3&#65379;
&nbsp;&lt;Function-Call&gt; =&gt; &#65378;console.log( "Hey, did you know a = " + a + "?" )&#65379;
&nbsp; &nbsp; &lt;String&gt; =&gt; &#65378;"Hey, did you know a = " &#65379;
&nbsp; &nbsp; &lt;Variable&gt; =&gt; &#65378;a &#65379;
&nbsp; &nbsp; &lt;String&gt; =&gt; &#65378;"?" &#65379;
</code></pre>
This makes it almost too easy to figure out how to print out text, and points out a tiny problem in our regular expression. Let's print out the number we've assigned <i>a</i>&nbsp;to, just to start out with. The first line tells us the root of the directory, or match, tree is <i>$/</i>.&nbsp;&nbsp;If you add 'say $/;' to the end of your test file and rerun it, you'll see the entire expression printed out twice. That must mean that <i>$/</i>&nbsp;is the entire match.<br />
<br />
Going down one layer is just as easy as adding what's on the left side of the =&gt; arrow. Change the previous 'say' statement to 'say $/&lt;Assignment-Expression&gt;;', and look at how the output changes. It should now look like this:<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">&#65378;var a = 3&#65379;
&nbsp; Variable =&gt; &#65378;a &#65379;
&nbsp; Number =&gt; &#65378;3&#65379;
</code></pre>
Let's put our (invisible) markers back in, so we can see where to go...
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">$/&lt;Assignment-Expression&gt; =&gt; &#65378;var a = 3&#65379;
&nbsp; &lt;Variable&gt; =&gt; &#65378;a &#65379;
&nbsp; &lt;Number&gt; =&gt; &#65378;3&#65379;
</code></pre>
We can now see that our target, the number 3, is just one layer further down. Again, we can add what's on the left-hand side of the expression, so let's do just that.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say $/&lt;Assignment-Expression&gt;&lt;Number&gt;;
&nbsp; &#65378;3&#65379;
</code></pre>
And we have almost exactly what we want. The &#65378;&#65379; are in the way, so let's "cast" the value here back to a number. I've put "cast" in scare quotes because it's not <b>quite</b>&nbsp;what C/C++ programmers think of as "casting". What we want to do is roughly the equivalent of 'sscanf(str,"%d",&amp;num)", but in Perl 6, the operation is much simpler.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say +$/&lt;Assignment-Expression&gt;&lt;Number&gt;;
&nbsp; 3
</code></pre>
Without getting into too much detail, <i>$/</i>&nbsp;is an object that has an implicit number, string and boolean value hiding inside of it. Adding '+' to the front reveals the hidden number inside the <i>$/</i>&nbsp;object.<br />
<br />
<h2>
From JavaScript to Perl</h2>
We're not too far off from being able to generate Perl 6 code from our JavaScript. Let's use what we've learned above with our first statement, the assignment.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'my $' ~ $/&lt;Assignment-Expression&gt;&lt;Variable&gt; ~ ' = ' ~
&nbsp; &nbsp; &nbsp; $/&lt;Assignment-Expression&gt;&lt;Number&gt; ~ ';';

my $a = 3;
</code></pre>
We've just used 7 lines of Perl 6 to turn code in one language into another language. And most of the Perl 6 code is reusable, because strings, numbers and JavaScript/C/Java-style variable names are common across most languages out there.<br />
<br />
Last time, we learned how to create matches using regular expressions. This time we've learned how we can <b>use</b>&nbsp;what we've matched, and how to find what we want inside a <i>say</i>&nbsp;statement. The invisible matching markers are useful enough that I might actually write a module that puts them back into match expressions, it shouldn't be hard.<br />
<br />
There is one problem with that scheme, and if we look at the &lt;Function-Call&gt; matches, it's pretty easy to see the problem.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">$/&lt;Function-Call&gt; =&gt; &#65378;console.log( "Hey, did you know a = " + a + "?" )&#65379;
&nbsp; &lt;String&gt; =&gt; &#65378;"Hey, did you know a = " &#65379;
&nbsp; &lt;Variable&gt; =&gt; &#65378;a &#65379;
&nbsp; &lt;String&gt; =&gt; &#65378;"?" &#65379;
</code></pre>
When we write "say $/&lt;Function-Call&gt;&lt;String&gt;;", which &lt;String&gt; will we get? Before you run this, try to guess. Is it the first one, because Perl 6 won't replace a match object once it's been created? Is it the last one, because the last one "overwrites" the first one? Does the compiler simply "get confused" and prints nothing? Try it and see!<br />
<br />
It actually returns both matches in a list, so you can reference either one. Our invisible markers now get to look like
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">$/&lt;Function-Call&gt; =&gt; &#65378;console.log( "Hey, did you know a = " + a + "?" )&#65379;
&nbsp; &lt;String&gt;[0] =&gt; &#65378;"Hey, did you know a = " &#65379;
&nbsp; &lt;Variable&gt; =&gt; &#65378;a &#65379;
&nbsp; &lt;String&gt;[1] =&gt; &#65378;"?" &#65379;
</code></pre>
So if we want to print out the first string, we can write "say $/&lt;Function-Call&gt;&lt;String&gt;[0];" and get back &nbsp;&#65378;"Hey, did you know a = " &#65379; complete with the funky Japanese quotation marks. Thankfully there's a shortcut to getting rid of those, just like there was with the number 3.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say ~$/&lt;Function-Call&gt;&lt;String&gt;[0];
&nbsp; "Hey, did you know a = "
</code></pre>
<br />
The '~" operator "stringifies" the match, just like '+' "numifies" the match that gets returned. So, you can probably write the final line yourself...<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'say ' ~ $/&lt;Function-Call&gt;&lt;String&gt;[0] ~ ' ~ '
&nbsp; ' $' ~ $/&lt;Function-Call&gt;&lt;Variable&gt; ~ ' ~ '
&nbsp; $&lt;Function-Call&gt;&lt;String&gt;[1] ~ ';';

say "Hey, did you know a = " ~ $a ~ "?";
</code></pre>
And we've compiled our two lines of JavaScript into Perl 6.<br />
<br />
<h2>
Refactoring</h2>
<div>
What we've got works, but there's quite a bit of repetition. Here's what we've got so far.</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule Variable { \w+ };
my rule String { '"' &lt;-[ " ]&gt;+ '"' };
my rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
my rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };

'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' }

say 'my $' ~ $/&lt;Assignment-Expression&gt;&lt;Variable&gt; ~
&nbsp; &nbsp; &nbsp; &nbsp;' = ' ~ $/&lt;Assignment-Expression&gt;&lt;Number&gt; ~
&nbsp; &nbsp; &nbsp; &nbsp;';';

say 'say ' ~ $/&lt;Function-Call&gt;&lt;String&gt;[0] ~
&nbsp; &nbsp; &nbsp; &nbsp;' ~ $' ~ $/&lt;Function-Call&gt;&lt;Variable&gt; ~
&nbsp; &nbsp; &nbsp; ' ~ ' ~ $/&lt;Function-Call&gt;&lt;String&gt;[1] ~
&nbsp; &nbsp; &nbsp; ';';
</code></pre>
<br />
The rules look pretty good, the repetitions of &lt;String&gt; and &lt;Variable&gt; are pretty much unavoidable, but look at the 'say' statements. You'll see that &lt;Assignment-Expression&gt; and &lt;Function-Call&gt; repeat themselves several times. One way to get rid of this repetition is to create a temporary variable, but that could get ugly.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my $assignment-expression = $/&lt;Assignment-Expression&gt;;
say 'my $' ~ $assignment-expression&lt;Variable&gt; ~ ' = ' ~
&nbsp; &nbsp; $assignment-expression&lt;Number&gt; ~ ';'
</code></pre>
Instead, let's take advantage of Perl 6's subroutine signatures, and reuse the <i>$/</i>&nbsp;variable name so we can reuse the code we wrote above, and just drop out the &lt;Assignment-Expression&gt; part. I'll name the subroutine after the rule, just to keep things straight. (You'll see why later.)<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">sub assignment-expression( $/ ) {
&nbsp; &nbsp; 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';'
}

say assignment-expression( $/&lt;Assignment-Expression&gt; );&nbsp;
</code></pre>
Let's do the same for &lt;Function-Call&gt; as well, creating a function with the same name and <i>$/</i>&nbsp;subroutine signature. It now fits neatly on one line, and only repeats the &lt;String&gt; bit because it has to.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">sub function-call( $/ ) {
&nbsp; &nbsp; 'say ' ~ $/&lt;String&gt;[0] ~ ' ~ ' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';'
}

say function-call( $/&lt;Function-Call&gt; );&nbsp;
</code></pre>
<h2>
Objectification</h2>
<div>
I've made quite a few choices along the way to get us to this point in the narrative. Here's where we are after the last bout of refactoring:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">
my rule Number { \d+ };
my rule Variable { \w+ };
my rule String { '"' &lt;-[ " ]&gt;+ '"' };
my rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
my rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };

'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' }

sub assignment-expression( $/ ) {
&nbsp; &nbsp; 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';'
}<br />
<br />
sub function-call( $/ ) {<br />
&nbsp; &nbsp; 'say ' ~ $/&lt;String&gt;[0] ~ ' ~ $' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';';<br />
}
say assignment-expression( $/&lt;Assignment-Expression&gt; );
say function-call( $/&lt;Function-Call&gt; );
</code></pre>
Here's where this all pays off. &nbsp;Let's pack up the last two 'say' calls first. We haven't given the top-level rule a name, so let's just call it ... well, 'top' for now.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">sub top( $/ ) { assignment-expression( $/ ) ~ function-Call( $/ ) }
</code></pre>
<h3>
Pack up your Troubles&nbsp;</h3>
<br />
We haven't done much with the rules sitting at the top of the file for a while, so let's work with those. In Perl 6, and for that matter programming in general, it's a good idea to package up your code for reuse. While Perl 6 lets us package up code with the 'class' keyword, the rules we have really aren't "code" in any sense. While they can be used in code, and we do use them, they don't really make any decisions on their own.<br />
<br />
So we shouldn't use the 'class' keyword to package them up. Instead, there's another convenient type meant for packaging up a bunch of regular expressions and rules, called a 'grammar'. It looks just like the syntax for declaring a 'rule', and that's actually by design.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">
grammar JavaScript {
&nbsp; rule Number { \d+ };
&nbsp; rule Variable { \w+ };
&nbsp; rule String { '"' &lt;-[ " ]&gt;+ '"' };
&nbsp; rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
&nbsp; rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };

&nbsp; rule TOP { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' };
}</code></pre>
You'll note that we gave our top-level rule a name as well, and just called it 'TOP' for the time being. If you're playing along at home, you've probably made the change and are wondering how the "'var a = 3;...' ~~ rule { ... }" thing plays out, because trying things like "'var a = 3;...' ~~ JavaScript;" won't quite work.<br />
<br />
Grammars are just like classes, in that they're really just clumps of potential code. They can't be made to do work on their own, they have to be converted from potential to .. well, kinetic code. We can do that just like you do with any class.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my $javaScript = JavaScript.new;</code></pre>
And now we have a variable that we can work with. Now, let's put it to work. All grammar classes come with a built-in 'parse()' method that we can use to get at the regular expressions inside it. Let's modify our match statement to take advantage of that -<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">
$javaScript.parse(
&nbsp; &nbsp; 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );');
</code></pre>
And our code should work again.<br />
<h3>
Taking Action</h3>
Now that we've bundled up all of our matching stuff into one tidy little class, it'd be nice if we could do the same for those subroutines. Let's try that here, and put our subroutines into their own namespace, just like we did with the rules. We'll have to change from 'sub' to 'method', and our 'top' method will have to use 'self.' to call the other methods.<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">class Actions {
&nbsp; &nbsp; method assignment-expression( $/ ) {
&nbsp; &nbsp; &nbsp; 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';'
&nbsp; &nbsp; }

&nbsp; &nbsp; method function-call( $/ ) {
&nbsp; &nbsp;   'say ' ~ $/&lt;String&gt;[0] ~ ' ~ $' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';';
&nbsp; &nbsp; }

&nbsp; &nbsp; method top( $/ ) {
&nbsp; &nbsp; &nbsp; &nbsp; self.assignment-expression( $/&lt;Assignment-Expression&gt; ) ~
&nbsp; &nbsp; &nbsp; &nbsp; self.function-call( $/&lt;Function-Call&gt; )
&nbsp; &nbsp; }
}</code></pre>
And just like before, we can create the Actions object in one line<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">&nbsp;my $actions = Actions.new;</code></pre>
And call the top <b>almost</b>&nbsp;like we did before.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say $actions.top( $/ );</code></pre>
We've changed things around quite a bit, so here's a look at where we stand.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">grammar JavaScript {
&nbsp; rule Number { \d+ };
&nbsp; rule Variable { \w+ };
&nbsp; rule String { '"' &lt;-[ " ]&gt;+ '"' };
&nbsp; rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
&nbsp; rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };
&nbsp; rule TOP { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' }
}
my $j = JavaScript.new;

$j.parse('var a = 3; console.log( "Hey, did you know a = " + a + "?" );');

class Actions {
&nbsp; &nbsp; method assignment-expression( $/ ) {
&nbsp; &nbsp; &nbsp; 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';'
&nbsp; &nbsp; }

&nbsp; &nbsp; method function-call( $/ ) {
&nbsp; &nbsp; &nbsp; 'say ' ~ $/&lt;String&gt;[0] ~ ' ~ $' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';';
&nbsp; &nbsp; }

&nbsp; &nbsp; method top( $/ ) {
&nbsp; &nbsp; &nbsp; self.assignment-expression( $/&lt;Assignment-Expression&gt; ) ~
&nbsp; &nbsp; &nbsp; self.function-call( $/&lt;Function-Call&gt; )
&nbsp; &nbsp; }
}

my $actions = Actions.new;
say $actions.top($/);</code></pre>
<br />
Don't worry, we're almost there. Now that we have a separate class for the actions, let's rename the methods to exactly match the grammar rules, so we don't forget what they are.
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">class Actions {
&nbsp; &nbsp; method Assignment-Expression( $/ ) {
&nbsp; &nbsp; &nbsp; 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';'
&nbsp; &nbsp; }

&nbsp; &nbsp; method Function-Call( $/ ) {
&nbsp; &nbsp; &nbsp; 'say ' ~ $/&lt;String&gt;[0] ~ ' ~ $' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';';
&nbsp; &nbsp; }

&nbsp; &nbsp; method TOP( $/ ) {
&nbsp; &nbsp; &nbsp; self.Assignment-Expression( $/&lt;Assignment-Expression&gt; ) ~
&nbsp; &nbsp; &nbsp; self.Function-Call( $/&lt;Function-Call&gt; )
&nbsp; &nbsp; }
}</code></pre>
Furthermore, there's one last bit of magic that we can take advantage of. We're going to combine the $javascript and $actions objects like so.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say $javascript.parse('....', :actions($actions) );</code></pre>
The ':actions(...)' is just a fancy way of declaring an optional argument to the 'parse()' method. We're telling the regular expression engine that any time a rule like &lt;Function-Call&gt; or &lt;TOP&gt; matches, we'd like it to call the corresponding method in our class.<br />
<br />
This almost works as-is, but if you run the code with these modifications, you'll see the parser returns the original match object, with those Japanese quote marks. So it seems like we're back at square one. Not quite.<br />
<br />
Go ahead and add a temporary "say 'Hello!';" to one of the methods, just to confirm that they're getting called. This is important proof that the regex engine is working and properly parsing what it's going over. You can even use some of the tricks we learned above and write "say $/&lt;Variable&gt;;" to see if the match is getting run as you thought it should. Go ahead and play around, come back here when you're done.<br />
<br />
<h3>
Mixed Signals</h3>
<div>
What's happening is the methods are getting called, but their output is being lost. Let's capture the output and use the final (ha!) feature of the grammar, the Abstract Syntax Tree. Now, this might dredge up notions of sitting in classrooms watching boxes and lines being drawn on the chalkboard, but it's not really that bad. We've already seen one, in fact the output from say() is an AST.</div>
<div>
<br /></div>
<div>
Let's look at the <b>other</b>&nbsp;syntax tree, the one we're building in the background. Add '.ast' to the end of the "$javascript.parse(...).ast;" call, like that. This will show us the syntax tree we're building on our own. Or will it?</div>
<div>
<br /></div>
<div>
If you do this, you'll see it prints <i>(Any)</i>, which generally is the equivalent of "failed match", but we know from previous testing that the match hasn't failed. So what's going on here? While our methods are getting run, and they return output, Perl 6 doesn't know what to do with the output, or where it fits in the AST it's been asked to build.</div>
<div>
<br /></div>
<div>
The key is a little thing called "make". Add this where we used to put 'say', at the start of the methods.</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">class Actions {
&nbsp; &nbsp; method Assignment-Expression( $/ ) {
&nbsp; &nbsp; &nbsp; make 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';'
&nbsp; &nbsp; }

&nbsp; &nbsp; method Function-Call( $/ ) {
&nbsp; &nbsp; &nbsp; make 'say ' ~ $/&lt;String&gt;[0] ~ ' ~ $' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';'
&nbsp; &nbsp; }

&nbsp; &nbsp; method TOP( $/ ) {
&nbsp; &nbsp; &nbsp; make $/&lt;Assignment-Expression&gt;.ast ~ $/&lt;Function-Call&gt;.ast
&nbsp; &nbsp; }
}</code></pre>
Also, because Perl 6 is calling the methods for us, we don't need to call self.Function-Call(...) on our own, all we need to do is look at the syntax tree that Function-Call(...) returns to us. And there we have it. A complete, albeit tiny compiler. In case you've gotten lost with the editing, here's the final result.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">grammar JavaScript {
&nbsp; rule Number { \d+ };
&nbsp; rule Variable { \w+ };
&nbsp; rule String { '"' &lt;-[ " ]&gt;+ '"' };
&nbsp; rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
&nbsp; rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };
&nbsp; rule TOP { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' }
}

class Actions {
&nbsp; method Assignment-Expression( $/ ) {
&nbsp; &nbsp; make 'my $' ~ $/&lt;Variable&gt; ~ ' = ' ~ $/&lt;Number&gt; ~ ';' }

&nbsp; method Function-Call( $/ ) {
&nbsp; &nbsp; make 'say ' ~ $/&lt;String&gt;[0] ~
&nbsp; &nbsp; &nbsp;' ~ $' ~ $/&lt;Variable&gt; ~ ' ~ ' ~ $/&lt;String&gt;[1] ~ ';'; }

&nbsp; method TOP( $/ ) {
&nbsp; &nbsp; make $/&lt;Assignment-Expression&gt;.ast ~ $/&lt;Function-Call&gt;.ast }
}

my $j = JavaScript.new;
my $a = Actions.new;
say $j.parse(
&nbsp;  'var a = 3; console.log( "Hey, did you know a = " + a + "?" );',
&nbsp;  :actions($a)).ast;</code></pre>
<h3>
Where Do We Go From Here&nbsp;</h3>
One simple but neat change you can do is expand the Assignment-Expression to accept both numbers and strings. We talked last time about alternatives in the rules, so this hint should be enough to get you started:<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">rule Assignment-Expression { var &lt;Variable&gt; '=' ( &lt;Number&gt; | &lt;String&gt; ) }</code></pre>
You'll have to modify the Assignment-Expression method a little bit to make this work. Or you could get crafty and realize that ( &lt;Number&gt; | &lt;String&gt; ) could be turned into its own little generic "Term" rule, "rule Term { &lt;Number&gt; | &lt;String&gt; }", add an action "method Term( $/ ) { make $/&lt;Number&gt; or $/&lt;String&gt; }" and only change one thing in Assignment-Expression.<br />
<br />
Time and again when helping people out online, I've had to say that Perl 5 regular expressions aren't <b>quite</b>&nbsp;the tool they need, whether they're trying to find a bit of HTML in a document, rewriting an RTF file or pulling out a title from a LaTeX doc. I've had to say "Use HTML::Parser", or "Check out the RTF modules on CPAN" or "Try Parser::MCG" to tackle these thorny questions.<br />
<br />
Perl 6 regular expressions can handle all of those tasks and much more. Plus, the techniques I've mentioned in this tutorial aren't specific to JavaScript. You can use these same techniques to parse any language that can be broken down into tokens. It may take some creative use of higher-level rules, but it can be done.<br />
<br />
Your methods don't have to return Perl 6 text when they parse JavaScript. They could just as easily count up the number of function calls, flag lines of code that can cause problems or do inline optimization. Perl 6 is written in Perl 6, so you could even use these techniques to compile from Perl 6 to JavaScript.<br />
<br />
Thank you, gentle reader, for making it this far with me. I hope you've learned something along the way, or at least been entertained by what vistas Perl 6 opens up. Next month I'll probably briefly return to Perl 5 and more real-world debugging.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2016/02/from-regular-expressions-to-grammars-pt_28.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_28.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2016-02-28T13:22:00+02:00'>13:22</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_28.html#comment-form' onclick=''>
No comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=6825670793909763328&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=6825670793909763328&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=6825670793909763328&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=6825670793909763328&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=6825670793909763328&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=6825670793909763328&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2016/02/from-regular-expressions-to-grammars-pt_28.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>20 February 2016</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='5431247843063773408' itemprop='blogId'/>
<meta content='7054899775203295696' itemprop='postId'/>
<a name='7054899775203295696'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_20.html'>From Regular Expressions to Grammars, Pt. 3</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-7054899775203295696' itemprop='description articleBody'>
If you haven't been following this series, please check out <a href="http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt.html" target="_blank">Part 1</a>&nbsp;of this series&nbsp;before continuing to read.<br />
<br />
<h2>
Movin' on up</h2>
After an admittedly whirlwind tour of the basic set of regular expressions, it's time to enter the big league. We'll take it slow, and just for variety, we'll tackle a bit of JavaScript. I've developed this technique over a few prior posts, so if you've been reading past entries this may seem a bit of a refresher.<br />
<br />
At the end of the series, we'll have created a small JIT interpreter for a small bit of JavaScript, to wit, this line:<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">var a = 3; console.log( "Hey, did you know a = " + a + "?" );
</code></pre>
We'll take this one step at a time. I generally like to put this into source code control so I can easily checkpoint and revert source when an approach doesn't work out. Like many people these days, I use git, but feel free to use mercurial, darcs, SVN or whatever works best for you.<br />
<br />
The best compiler in the world won't help if it can't read your input, so let's start with a simple test.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
/'var a = 3; console.log( "Hey, did you know a = " + a + "?" );'/
</code></pre>
The 'say' is included so that we can see the output from the match. Right now, we expect that since we're attempting to match a quoted string against an exact copy of itself, the match should trivially succeed. It's roughly the same as<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'Hello, world!' ~~ /'Hello, world!'/</code></pre>
The entire expression is enclosed within single quotes, so we don't have to concern ourselves with what gets quoted and what doesn't.<br />
<br />
Anyway, copy the "say 'a = 3...." statement into a file somewhere and run 'perl6 test.pl6', assuming your file is called 'test.pl6'. &nbsp;It should print out precisely what it matched, which is the string itself:<br />
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">jgoff@Demeisen:~$ perl6 test.pl6

&#65378;var a = 3; console.log( "Hey, did you know a = " + a + "?" );&#65379;
</code></pre>
This result lets us know that the match succeeded, and tells us that it matched the entire expression. So, go ahead and checkpoint this in your git (or whatever, I'll assume git from here on out) repository and let's dive in to refactor things just a bit.<br />
<br />
<h2>
Use Cases</h2>
<div>
If we were at this point to go ahead and write the compiler code, it'd end up being pretty boring. It would be able to compile that exact string to Perl 6 and generate 'my $a = 3; say "Hey, did you know a = " ~ $a ~ "?";', but it couldn't do anything else. See for yourself by changing the "say '...'" part of the expression to test your own variations.<br />
<br />
JavaScript commonly gets "minified" before being sent to the browser, with no unnecessary whitespace in the string. So, go ahead and remove the whitespace from the "say '...'" part of your expression, and rerun the test. I'll wait here.<br />
<br />
Did it match? I thought not. Do a 'git reset --hard' to get back to the last known-working point, and let's continue. While regular expressions are terribly powerful, they can also be very finicky, as we're about to learn. Let's focus for a few moments on just one of the statements in our compiler, the "a = 3;" statement.<br />
<br />
Programmers will come up with lots of creative ways to express this simple statement, from the terse 'a=3;' to tabbing out the '= 3' portion to line up with something else, to the extreme of even putting the semicolon on the next line so that they don't have to add it all the time when copying text around. (Yes, I've seen that style in the wild.)<br />
<br />
Remembering the rule that alphanumerics don't need to be escaped, we can combine what we've just learned and match all possible variants like so -<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'a=3;' ~~ / \s* a \s* '=' \s* 3 \s* ';' \s*/
</code></pre>
Which matches any whitespace variant you can dream up, anything from "a=3;" to "\n &nbsp; &nbsp;a &nbsp; &nbsp; = 3;" and beyond. There are two lessons to be learned here. The first is that by breaking up our string wherever a programmer might want to insert whitespace, we've taken our first step towards "tokenizing" the expression. We'll go into more depth about that later.<br />
<br />
The second is that while it's more flexible, the expression now has these \s* scattered throughout it, making it a little harder to read. Also, inserting "\s*" between every word seems like something a computer should be able to do. And in fact, it can. And there's already a shorthand in Perl 6 for this.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'a=3;' ~~ rule { a '=' 3 ';' }
</code></pre>
No more \s* interrupting us between every place we might want to put whitespace. Let's get back to our original expression and apply what we've learned here.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { var a '=' 3 ';'
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console '.' log '(' '"Hey, did you know a = "' '+' a '+' '"?"' ')' ';' }
</code></pre>
<br />
<h2>
Structure and Form</h2>
</div>
<div>
You might notice that "Hey, did you know a = " and "?" didn't receive the same quoting treatment as the other parts of the rule. While there are some deep reasons here, the main one is practicality. Eventually this compiler we're writing should be able to accept "!" instead of "?", "Hello world!" instead of "Hey...", and we want to make sure all of these input strings are acceptable.</div>
<div>
<br /></div>
<div>
So, it's time for a bit of refactoring. Let's take a fairly short expression, "Hello, world!" to work with. You might remember from the last section that the \w shorthand matches alphanumerics, so a first cut at refactoring "Hello, world!" might look like this:</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say '"Hello, world!"' ~~ rule { '"' \w+ ',' \w+ '!' '"' }
</code></pre>
And indeed, that will match. It'll match "Goodbye, world!", "Frankly, dear!" and a host of other expressions. It'd be nice, though, if there were a way to combine the \w, ',' and '!' into one thing that we could then match on, because that would let us match "hello!", "Whats up, doc" and a <b>lot</b>&nbsp;more. Again, yes, there is a shortcut for that.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say '"Hello, world!"' ~~ rule { '"' &lt;[ \s \w , ! ]&gt;+ '"' }
</code></pre>
lets you match a group of characters and/or shortcuts, so &lt;[ a b c ]&gt; on its own would match 'a', 'b' or 'c' but not '3' or '32'. We're still not quite there, because there's a lot more to add in to that expression, you'd have to add '?', '+', '.', ';' for starters, like &lt;[ \s \w , ! ? + . ; ]&gt; and so on. And when you bring Unicode into the mix, you'll have to add another million-plus characters for the CJKV region alone.<br />
<br />
By now you won't be surprised at all to learn that yes, there's a shortcut for this too. The shortest of all shortcuts, it's simply '.'. So our expression now looks like<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say '"Hello, world!"' ~~ rule { '"' .+ '"' }
</code></pre>
Which says "Match a quotation mark, then anything, then another quotation mark." And if you spell it out like that, you can probably spot the problem as fast as I did. Simply put, the '.' shortcut matches <b>any</b>&nbsp;character, and yes, this includes the&nbsp;&#65378;"&#65379; (using Japanese quotation marks to make the problem a little clearer.) So what we really want to do is "Match a quotation mark, then anything but the quotation mark, then another quotation mark."<br />
<br />
You say "Anything but" in regex-speak like &lt;-[..]&gt;, where the [..] is whatever you <b>don't</b>&nbsp;want to match. We want "anything but a quotation mark", so in to the [] the quotation mark goes, like so:<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { var a '=' 3 ';'
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console '.' log '(' '"' &lt;-[ " ]&gt; '"' '+' a '+' '"' &lt;-[ " ]&gt; '"' ')' ';' }
</code></pre>
In real-world code people like to put quotation marks inside quoted strings, but we won't worry about those for the moment.<br />
<br />
<h2>
Nest Eggs</h2>
<div>
Checkpoint here, and go ahead and play with the strings and whitespace. It can now match 'a=3;console.log("Hey, "+a+" is 3!");' and a bunch of other expressions. Those single-quoted double-quotes do stand out, though, especially since there are two of them. Since we've already got a rule, let's create a new rule just to hold those, and give it a name.</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule String { '"' &lt;-[ " ]&gt; '"' };

say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { var a '=' 3 ';'
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console '.' log '(' '"' .+ '"' '+' a '+' '"' .+ '"' ')' ';' }
</code></pre>
Of course, we've still got the original text below, so we'll take a cue from the character groups that we touched on briefly, and put the name in '&lt;'...'&gt;' as well.
<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule String { '"' &lt;-[ " ]&gt; '"' };

say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { var a '=' 3 ';'
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console '.' log '(' &lt;String&gt; '+' a '+' &lt;String&gt; ')' ';' }
</code></pre>
We've just refactored the 'console.log....' expression into something that humans can readily understand, and in fact expand upon as well. Building on the principle of not repeating yourself, we can notice that the variable is repeated in the string, so let's factor that out as well.<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule Variable { \w+ };
my rule String { '"' &lt;-[ " ]&gt; '"' };

say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { var &lt;Variable&gt; '=' 3 ';'
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' ';' }
</code></pre>
We may as well factor out the number as well...<br />
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule Number { \d+ };
my rule Variable { \w+ };
my rule String { '"' &lt;-[ " ]&gt; '"' };

say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { var &lt;Variable&gt; '=' &lt;Number&gt; ';'
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' ';' }
</code></pre>
<br />
<h2>
Mere Semantics</h2>
<div>
You may have noticed that I used '\w+' to match Variables, rather than 'a'. While this allows users of the eventual compiler to write 'var Lennier = 5;' rather than the more prosaic 'var a = 23;', it also allows users to write semantically invalid code. To wit, 'var Prisoner = 6; console.log("I am not " + a + " a number");' where <i>a</i>&nbsp;is not defined.</div>
<div>
<br /></div>
<div>
In principle, we could change the rule so that the second instance of &lt;Variable&gt; must have the same value as the first instance. That way our previous Prisoner example would fail, because 'a' would not be the same as 'Prisoner', and it only allows syntactically and semantically correct code to pass the test.</div>
<div>
<br /></div>
<div>
That's wonderful in principle, and keeps the changes localized to the final rule. Great, and your test suite might even pass, and you release your module out into the real world.</div>
<div>
<br /></div>
<div>
Then someone comes along and writes 'var test = 1; var a = 2; console.log("Hi, test = " + test + ".");'. Which is perfectly valid JavaScript code, and will compile everywhere... except in your compiler. So you say "fine, I'll check for any assignment statements after the function definition. And then someone writes a closure with a 'console.log( .. + variable_outside_the_function + ...)' and breaks your code again.</div>
<div>
<br /></div>
<div>
In summation, let your rules catch syntax errors only, anything else can and should be handled outside. In the fourth and final installment of this series, we'll build a compiler out of this. But let's do one final burst of refactoring in order to clarify the statements.</div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">my rule Number { \d+ };
my rule Variable { \w+ };
my rule String { '"' &lt;-[ " ]&gt;+ '"' };
my rule Assignment-Expression { var &lt;Variable&gt; '=' &lt;Number&gt; };
my rule Function-Call { console '.' log '(' &lt;String&gt; '+' &lt;Variable&gt; '+' &lt;String&gt; ')' };

say 'var a = 3; console.log( "Hey, did you know a = " + a + "?" );' ~~
rule { &lt;Assignment-Expression&gt; ';' &lt;Function-Call&gt; ';' }
</code></pre>
You've seen the individual pieces before, but probably not put together quite like this. The &lt;Assignment-Expression&gt; rule matches the entirety of 'var foo = 27', and the &lt;Function-Call&gt; part matches 'console.log("Take " + foo + " down, pass them around")' Our final rule puts the pieces together, matching an assignment statement followed by a function call. I've left the ';' separators outside the &lt;Assignment-Expression&gt; and &lt;Function-Call&gt; because they separate expressions, they're not <b>part</b>&nbsp;of them.<br />
<br />
<h2>
Winding Down</h2>
<div>
The technique applied here isn't specific to JavaScript, of course. Generally, if you can put whitespace around something without changing its semantics, you've found a token like &lt;Number&gt; or &lt;String&gt;. Figure out where those breaks are, and you're already halfway to decoding the language in question. Figuring out the higher-level rules is much more fun, and along the way you'll find yourself making notes "Okay, lists act like this, wait, can I put a &lt;List&gt; <b>inside</b>&nbsp;a list? Yes? Hey..."</div>
<div>
<br /></div>
<div>
Starting from a string, we've split it into chunks, then factored out some of those chunks into their own rules. Once we could abstract out the 32 into a number, foo_bar into a variable and figure out the String type, it's a question of putting them together in combinations, like '&lt;Variable&gt; = &lt;Number&gt;'. If you want, you can even take what we've done above and refactor it down more.</div>
<div>
<br /></div>
<pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">
my rule Variable-Declaration { var &lt;Assignment-Expression&gt; }
my rule Assignment-Expression { &lt;Variable&gt; '=' ( &lt;Number&gt; | &lt;String&gt; | &lt;Variable&gt; ) }
</code></pre>
Hopefully you can see where this is going, because this handles 'var a = 32; var b = c; var d = "hi"' along with so much more. But this will have to wait for Part 4.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/18252182597447689159' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' title='author profile'>
<span itemprop='name'>DrForr</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='http://theperlfisher.blogspot.com/2016/02/from-regular-expressions-to-grammars-pt_20.html' itemprop='url'/>
<a class='timestamp-link' href='http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_20.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2016-02-20T17:11:00+02:00'>17:11</abbr></a>
</span>
<span class='reaction-buttons'>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://theperlfisher.blogspot.ro/2016/02/from-regular-expressions-to-grammars-pt_20.html#comment-form' onclick=''>
2 comments:
    </a>
</span>
<span class='post-backlinks post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-492201844'>
<a href='https://www.blogger.com/post-edit.g?blogID=5431247843063773408&postID=7054899775203295696&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7054899775203295696&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7054899775203295696&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7054899775203295696&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7054899775203295696&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5431247843063773408&postID=7054899775203295696&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://theperlfisher.blogspot.com/2016/02/from-regular-expressions-to-grammars-pt_20.html' size='medium' width='300' annotation='inline'/></div>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='http://theperlfisher.blogspot.ro/search?updated-max=2016-02-20T17:11:00%2B02:00&amp;max-results=7' id='Blog1_blog-pager-older-link' title='Older Posts'>Older Posts</a>
</span>
<a class='home-link' href='http://theperlfisher.blogspot.ro/'>Home</a>
</div>
<div class='clear'></div>
<div class='blog-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='http://theperlfisher.blogspot.com/feeds/posts/default' target='_blank' type='application/atom+xml'>Posts (Atom)</a>
</div>
</div>
<script type='text/javascript'>
    window.___gcfg = { 'lang': 'en' };
  </script>
</div></div>
</div>
</div>
<div class='column-left-outer'>
<div class='column-left-inner'>
<aside>
</aside>
</div>
</div>
<div class='column-right-outer'>
<div class='column-right-inner'>
<aside>
<div class='sidebar section' id='sidebar-right-1'><div class='widget Profile' data-version='1' id='Profile1'>
<h2>About Me</h2>
<div class='widget-content'>
<dl class='profile-datablock'>
<dt class='profile-data'>
<a class='profile-name-link g-profile' href='https://www.blogger.com/profile/18252182597447689159' rel='author' style='background-image: url(//www.blogger.com/img/logo-16.png);'>
DrForr
</a>
</dt>
</dl>
<a class='profile-link' href='https://www.blogger.com/profile/18252182597447689159' rel='author'>View my complete profile</a>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5431247843063773408&widgetType=Profile&widgetId=Profile1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("Profile1"));' target='configProfile1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Blog Archive</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2018/'>
2018
</a>
<span class='post-count' dir='ltr'>(3)</span>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2018/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
<ul class='posts'>
<li><a href='http://theperlfisher.blogspot.ro/2018/03/who-ordered-that-array.html'>Who ordered that (array)?</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2018/01/'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2017/'>
2017
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2017/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2017/04/'>
April
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2016/'>
2016
</a>
<span class='post-count' dir='ltr'>(6)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2016/02/'>
February
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2016/01/'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2015/'>
2015
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2015/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://theperlfisher.blogspot.ro/2015/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5431247843063773408&widgetType=BlogArchive&widgetId=BlogArchive1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("BlogArchive1"));' target='configBlogArchive1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div></div>
</aside>
</div>
</div>
</div>
<div style='clear: both'></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class='main-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<footer>
<div class='footer-outer'>
<div class='footer-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left footer-fauxborder-left'>
<div class='fauxborder-right footer-fauxborder-right'></div>
<div class='region-inner footer-inner'>
<div class='foot no-items section' id='footer-1'></div>
<!-- outside of the include in order to lock Attribution widget -->
<div class='foot section' id='footer-3' name='Footer'><div class='widget Attribution' data-version='1' id='Attribution1'>
<div class='widget-content' style='text-align: center;'>
Simple theme. Powered by <a href='https://www.blogger.com' target='_blank'>Blogger</a>.
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5431247843063773408&widgetType=Attribution&widgetId=Attribution1&action=editWidget&sectionId=footer-3' onclick='return _WidgetManager._PopupConfig(document.getElementById("Attribution1"));' target='configAttribution1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div></div>
</div>
</div>
<div class='footer-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class='content-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<script type='text/javascript'>
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>
<script src='https://apis.google.com/js/plusone.js' type='text/javascript'></script>
<!--It is your responsibility to notify your visitors about cookies used on your blog. See http://www.blogger.com/go/cookiechoices for more details.-->
<script defer='' src='/js/cookiechoices.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function(event) {
      window.cookieChoices && cookieChoices.showCookieConsentBar && cookieChoices.showCookieConsentBar(
          (window.cookieOptions && cookieOptions.msg) || 'This site uses cookies from Google to deliver its services, to personalize ads and to analyze traffic. Information about your use of this site is shared with Google. By using this site, you agree to its use of cookies.',
          (window.cookieOptions && cookieOptions.close) || 'Got it',
          (window.cookieOptions && cookieOptions.learn) || 'Learn More',
          (window.cookieOptions && cookieOptions.link) || 'https://www.blogger.com/go/blogspot-cookies');
    });
  </script>

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/698371418-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY5ovfPkFRET-_87bm7kmkCQat8cdw:1521039581791';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d5431247843063773408','//theperlfisher.blogspot.ro/','5431247843063773408');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '5431247843063773408', 'title': 'The Perl Fisher', 'url': 'http://theperlfisher.blogspot.ro/', 'canonicalUrl': 'http://theperlfisher.blogspot.com/', 'homepageUrl': 'http://theperlfisher.blogspot.ro/', 'searchUrl': 'http://theperlfisher.blogspot.ro/search', 'canonicalHomepageUrl': 'http://theperlfisher.blogspot.com/', 'blogspotFaviconUrl': 'http://theperlfisher.blogspot.ro/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22The Perl Fisher - Atom\x22 href\x3d\x22http://theperlfisher.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22The Perl Fisher - RSS\x22 href\x3d\x22http://theperlfisher.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22The Perl Fisher - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/5431247843063773408/posts/default\x22 /\x3e\n', 'meTag': '\x3clink rel\x3d\x22me\x22 href\x3d\x22https://www.blogger.com/profile/18252182597447689159\x22 /\x3e\n', 'openIdOpTag': '\x3clink rel\x3d\x22openid.server\x22 href\x3d\x22https://www.blogger.com/openid-server.g\x22 /\x3e\n\x3clink rel\x3d\x22openid.delegate\x22 href\x3d\x22http://theperlfisher.blogspot.com/\x22 /\x3e\n', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'ieCssRetrofitLinks': '\x3c!--[if IE]\x3e\x3cscript type\x3d\x22text/javascript\x22 src\x3d\x22https://www.blogger.com/static/v1/jsbin/3658603751-ieretrofit.js\x22\x3e\x3c/script\x3e\n\x3c![endif]--\x3e', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/6724040bb52bb8c9', 'plusOneApiSrc': 'https://apis.google.com/js/plusone.js', 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Google+', 'key': 'googlePlus', 'shareMessage': 'Share to Google+', 'target': 'googleplus'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'googlePlusShareButtonWidth': 300, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'index', 'pageName': '', 'pageTitle': 'The Perl Fisher'}}, {'name': 'features', 'data': {'lazy_images': 'false', 'sharing_get_link_dialog': 'true', 'sharing_native': 'false'}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'name': 'custom', 'localizedName': 'Custom', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': true, 'variant': 'simplysimple', 'variantId': 'simplysimple'}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'The Perl Fisher', 'description': '', 'url': 'http://theperlfisher.blogspot.ro/', 'type': 'feed', 'isSingleItem': false, 'isMultipleItems': true, 'isError': false, 'isPage': false, 'isPost': false, 'isHomepage': true, 'isArchive': false, 'isLabelSearch': false}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', null, document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', null, document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', null, document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'useNgc': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1477909662-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/368954415-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_ProfileView', new _WidgetInfo('Profile1', 'sidebar-right-1', null, document.getElementById('Profile1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', null, document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', null, document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>
</body>
</html>